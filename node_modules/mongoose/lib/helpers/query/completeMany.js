'use strict';

const helpers = require('../../queryhelpers');

module.exports = completeMany;

/*!
 * Given a model and an array of docs, hydrates all the docs to be instances
 * of the model. Used to initialize docs returned from the db from `find()`
 *
 * @param ***REMOVED***Model***REMOVED*** model
 * @param ***REMOVED***Array***REMOVED*** docs
 * @param ***REMOVED***Object***REMOVED*** fields the projection used, including `select` from schemas
 * @param ***REMOVED***Object***REMOVED*** userProvidedFields the user-specified projection
 * @param ***REMOVED***Object***REMOVED*** opts
 * @param ***REMOVED***Array***REMOVED*** [opts.populated]
 * @param ***REMOVED***ClientSession***REMOVED*** [opts.session]
 * @param ***REMOVED***Function***REMOVED*** callback
 */

function completeMany(model, docs, fields, userProvidedFields, opts, callback) ***REMOVED***
  const arr = [];
  let count = docs.length;
  const len = count;
  let error = null;

  function init(_error) ***REMOVED***
    if (_error != null) ***REMOVED***
      error = error || _error;
    ***REMOVED***
    if (error != null) ***REMOVED***
      --count || process.nextTick(() => callback(error));
      return;
    ***REMOVED***
    --count || process.nextTick(() => callback(error, arr));
  ***REMOVED***

  for (let i = 0; i < len; ++i) ***REMOVED***
    arr[i] = helpers.createModel(model, docs[i], fields, userProvidedFields);
    try ***REMOVED***
      arr[i].init(docs[i], opts, init);
    ***REMOVED*** catch (error) ***REMOVED***
      init(error);
    ***REMOVED***
    arr[i].$session(opts.session);
  ***REMOVED***
***REMOVED***
