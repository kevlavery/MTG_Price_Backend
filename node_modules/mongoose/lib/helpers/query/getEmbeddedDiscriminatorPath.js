'use strict';

const get = require('lodash.get');

/*!
 * Like `schema.path()`, except with a document, because impossible to
 * determine path type without knowing the embedded discriminator key.
 */

module.exports = function getEmbeddedDiscriminatorPath(schema, update, filter, path) ***REMOVED***
  const parts = path.split('.');
  let schematype = null;
  let type = 'adhocOrUndefined';

  filter = filter || ***REMOVED******REMOVED***;
  update = update || ***REMOVED******REMOVED***;

  for (let i = 0; i < parts.length; ++i) ***REMOVED***
    const subpath = parts.slice(0, i + 1).join('.').
      replace(/\.\$\./i, '.0.').replace(/\.\$$/, '.0');
    schematype = schema.path(subpath);
    if (schematype == null) ***REMOVED***
      continue;
    ***REMOVED***
    type = schema.pathType(subpath);
    if ((schematype.$isSingleNested || schematype.$isMongooseDocumentArrayElement) &&
        schematype.schema.discriminators != null) ***REMOVED***
      const discriminators = schematype.schema.discriminators;
      const discriminatorValuePath = subpath + '.' +
        get(schematype, 'schema.options.discriminatorKey');
      const discriminatorFilterPath =
        discriminatorValuePath.replace(/\.\d+\./, '.');
      let discriminatorKey = null;
      if (discriminatorValuePath in filter) ***REMOVED***
        discriminatorKey = filter[discriminatorValuePath];
      ***REMOVED***
      if (discriminatorFilterPath in filter) ***REMOVED***
        discriminatorKey = filter[discriminatorFilterPath];
      ***REMOVED***
      if (discriminatorKey == null || discriminators[discriminatorKey] == null) ***REMOVED***
        continue;
      ***REMOVED***
      const rest = parts.slice(i + 1).join('.');
      schematype = discriminators[discriminatorKey].path(rest);
      if (schematype != null) ***REMOVED***
        type = discriminators[discriminatorKey]._getPathType(rest);
        break;
      ***REMOVED***
    ***REMOVED***
  ***REMOVED***

  return ***REMOVED*** type: type, schematype: schematype ***REMOVED***;
***REMOVED***;
