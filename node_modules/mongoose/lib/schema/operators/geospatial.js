/*!
 * Module requirements.
 */

var castArraysOfNumbers = require('./helpers').castArraysOfNumbers;
var castToNumber = require('./helpers').castToNumber;

/*!
 * ignore
 */

exports.cast$geoIntersects = cast$geoIntersects;
exports.cast$near = cast$near;
exports.cast$within = cast$within;

function cast$near(val) ***REMOVED***
  var SchemaArray = require('../array');

  if (Array.isArray(val)) ***REMOVED***
    castArraysOfNumbers(val, this);
    return val;
  ***REMOVED***

  _castMinMaxDistance(this, val);

  if (val && val.$geometry) ***REMOVED***
    return cast$geometry(val, this);
  ***REMOVED***

  return SchemaArray.prototype.castForQuery.call(this, val);
***REMOVED***

function cast$geometry(val, self) ***REMOVED***
  switch (val.$geometry.type) ***REMOVED***
    case 'Polygon':
    case 'LineString':
    case 'Point':
      castArraysOfNumbers(val.$geometry.coordinates, self);
      break;
    default:
      // ignore unknowns
      break;
  ***REMOVED***

  _castMinMaxDistance(this, val);

  return val;
***REMOVED***

function cast$within(val) ***REMOVED***
  _castMinMaxDistance(this, val);

  if (val.$box || val.$polygon) ***REMOVED***
    var type = val.$box ? '$box' : '$polygon';
    val[type].forEach(function(arr) ***REMOVED***
      if (!Array.isArray(arr)) ***REMOVED***
        var msg = 'Invalid $within $box argument. '
            + 'Expected an array, received ' + arr;
        throw new TypeError(msg);
      ***REMOVED***
      arr.forEach(function(v, i) ***REMOVED***
        arr[i] = castToNumber.call(this, v);
      ***REMOVED***);
    ***REMOVED***);
  ***REMOVED*** else if (val.$center || val.$centerSphere) ***REMOVED***
    type = val.$center ? '$center' : '$centerSphere';
    val[type].forEach(function(item, i) ***REMOVED***
      if (Array.isArray(item)) ***REMOVED***
        item.forEach(function(v, j) ***REMOVED***
          item[j] = castToNumber.call(this, v);
        ***REMOVED***);
      ***REMOVED*** else ***REMOVED***
        val[type][i] = castToNumber.call(this, item);
      ***REMOVED***
    ***REMOVED***);
  ***REMOVED*** else if (val.$geometry) ***REMOVED***
    cast$geometry(val, this);
  ***REMOVED***

  return val;
***REMOVED***

function cast$geoIntersects(val) ***REMOVED***
  var geo = val.$geometry;
  if (!geo) ***REMOVED***
    return;
  ***REMOVED***

  cast$geometry(val, this);
  return val;
***REMOVED***

function _castMinMaxDistance(self, val) ***REMOVED***
  if (val.$maxDistance) ***REMOVED***
    val.$maxDistance = castToNumber.call(self, val.$maxDistance);
  ***REMOVED***
  if (val.$minDistance) ***REMOVED***
    val.$minDistance = castToNumber.call(self, val.$minDistance);
  ***REMOVED***
***REMOVED***
