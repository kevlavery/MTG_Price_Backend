var fs = require('fs');
var jade = require('jade');
var package = require('./package');
var linktype = require('./docs/helpers/linktype');
var href = require('./docs/helpers/href');
var klass = require('./docs/helpers/klass');

const markdown = require('marked');
const highlight = require('highlight.js');
markdown.setOptions(***REMOVED***
  highlight: function(code) ***REMOVED***
    return highlight.highlight('JavaScript', code).value;
  ***REMOVED***
***REMOVED***);

jade.filters.markdown = markdown;

function getVersion() ***REMOVED***
  return require('./package.json').version;
***REMOVED***

function getLatestLegacyVersion(startsWith) ***REMOVED***
  var hist = fs.readFileSync('./History.md', 'utf8').replace(/\r/g, '\n').split('\n');
  for (var i = 0; i < hist.length; ++i) ***REMOVED***
    var line = (hist[i] || '').trim();
    if (!line) ***REMOVED***
      continue;
    ***REMOVED***
    var match = /^\s*([^\s]+)\s/.exec(line);
    if (match && match[1] && match[1].startsWith(startsWith)) ***REMOVED***
      return match[1];
    ***REMOVED***
  ***REMOVED***
  throw new Error('no match found');
***REMOVED***

// use last release
package.version = getVersion();
package.latest4x = getLatestLegacyVersion('4.');
package.latest38x = getLatestLegacyVersion('3.8');

var filemap = require('./docs/source');
var files = Object.keys(filemap);

function jadeify(filename, options, newfile) ***REMOVED***
  options = options || ***REMOVED******REMOVED***;
  options.package = package;
  options.linktype = linktype;
  options.href = href;
  options.klass = klass;
  jade.renderFile(filename, options, function(err, str) ***REMOVED***
    if (err) ***REMOVED***
      console.error(err.stack);
      return;
    ***REMOVED***

    newfile = newfile || filename.replace('.jade', '.html');
    fs.writeFile(newfile, str, function(err) ***REMOVED***
      if (err) ***REMOVED***
        console.error('could not write', err.stack);
      ***REMOVED*** else ***REMOVED***
        console.log('%s : rendered ', new Date, newfile);
      ***REMOVED***
    ***REMOVED***);
  ***REMOVED***);
***REMOVED***

files.forEach(function(file) ***REMOVED***
  var filename = __dirname + '/' + file;
  jadeify(filename, filemap[file]);

  if (process.argv[2] === '--watch') ***REMOVED***
    fs.watchFile(filename, ***REMOVED***interval: 1000***REMOVED***, function(cur, prev) ***REMOVED***
      if (cur.mtime > prev.mtime) ***REMOVED***
        jadeify(filename, filemap[file]);
      ***REMOVED***
    ***REMOVED***);
  ***REMOVED***
***REMOVED***);

var acquit = require('./docs/source/acquit');
var acquitFiles = Object.keys(acquit);
acquitFiles.forEach(function(file) ***REMOVED***
  var filename = __dirname + '/docs/acquit.jade';
  jadeify(filename, acquit[file], __dirname + '/docs/' + file);
***REMOVED***);
