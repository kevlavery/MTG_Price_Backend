
var mongoose = require('../../lib');
var Schema = mongoose.Schema;

console.log('Running mongoose version %s', mongoose.version);

/**
 * Console schema
 */

var consoleSchema = Schema(***REMOVED***
  name: String,
  manufacturer: String,
  released: Date
***REMOVED***);
var Console = mongoose.model('Console', consoleSchema);

/**
 * Game schema
 */

var gameSchema = Schema(***REMOVED***
  name: String,
  developer: String,
  released: Date,
  consoles: [***REMOVED***
    type: Schema.Types.ObjectId,
    ref: 'Console'
  ***REMOVED***]
***REMOVED***);
var Game = mongoose.model('Game', gameSchema);

/**
 * Connect to the console database on localhost with
 * the default port (27017)
 */

mongoose.connect('mongodb://localhost/console', function(err) ***REMOVED***
  // if we failed to connect, abort
  if (err) throw err;

  // we connected ok
  createData();
***REMOVED***);

/**
 * Data generation
 */

function createData() ***REMOVED***
  Console.create(
    ***REMOVED***
      name: 'Nintendo 64',
      manufacturer: 'Nintendo',
      released: 'September 29, 1996'
    ***REMOVED***,
    ***REMOVED***
      name: 'Super Nintendo',
      manufacturer: 'Nintendo',
      released: 'August 23, 1991'
    ***REMOVED***,
    function(err, nintendo64, superNintendo) ***REMOVED***
      if (err) return done(err);

      Game.create(
        ***REMOVED***
          name: 'Legend of Zelda: Ocarina of Time',
          developer: 'Nintendo',
          released: new Date('November 21, 1998'),
          consoles: [nintendo64]
        ***REMOVED***,
        ***REMOVED***
          name: 'Mario Kart',
          developer: 'Nintendo',
          released: 'September 1, 1992',
          consoles: [superNintendo]
        ***REMOVED***,
        function(err) ***REMOVED***
          if (err) return done(err);
          example();
        ***REMOVED***
      );
    ***REMOVED***
  );
***REMOVED***

/**
 * Population
 */

function example() ***REMOVED***
  Game
    .find(***REMOVED******REMOVED***)
    .exec(function(err, games) ***REMOVED***
      if (err) return done(err);

      console.log('found %d games', games.length);

      var options = ***REMOVED***path: 'consoles', select: 'name released -_id'***REMOVED***;
      Game.populate(games, options, function(err, games) ***REMOVED***
        if (err) return done(err);

        games.forEach(function(game) ***REMOVED***
          console.log(
            '"%s" was released for the %s on %s',
            game.name,
            game.consoles[0].name,
            game.released.toLocaleDateString()
          );
        ***REMOVED***);

        done();
      ***REMOVED***);
    ***REMOVED***);
***REMOVED***

function done(err) ***REMOVED***
  if (err) console.error(err);
  Console.remove(function() ***REMOVED***
    Game.remove(function() ***REMOVED***
      mongoose.disconnect();
    ***REMOVED***);
  ***REMOVED***);
***REMOVED***
