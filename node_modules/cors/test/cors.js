(function () ***REMOVED***
  /*global describe, it*/

  'use strict';

  var should = require('should'),
    cors = require('../lib');

  var fakeRequest = function (headers) ***REMOVED***
      return ***REMOVED***
        headers: headers || ***REMOVED***
          'origin': 'request.com',
          'access-control-request-headers': 'requestedHeader1,requestedHeader2'
        ***REMOVED***,
        pause: function () ***REMOVED***
          // do nothing
          return;
        ***REMOVED***,
        resume: function () ***REMOVED***
          // do nothing
          return;
        ***REMOVED***
      ***REMOVED***;
    ***REMOVED***,
    fakeResponse = function () ***REMOVED***
      var headers = ***REMOVED******REMOVED***;
      return ***REMOVED***
        allHeaders: function () ***REMOVED***
          return headers;
        ***REMOVED***,
        getHeader: function (key) ***REMOVED***
          return headers[key];
        ***REMOVED***,
        setHeader: function (key, value) ***REMOVED***
          headers[key] = value;
          return;
        ***REMOVED***,
        get: function (key) ***REMOVED***
          return headers[key];
        ***REMOVED***
      ***REMOVED***;
    ***REMOVED***;

  describe('cors', function () ***REMOVED***
    it('does not alter `options` configuration object', function () ***REMOVED***
      var options = Object.freeze(***REMOVED***
        origin: 'custom-origin'
      ***REMOVED***);
      (function () ***REMOVED***
        cors(options);
      ***REMOVED***).should.not.throw();
    ***REMOVED***);

    it('passes control to next middleware', function (done) ***REMOVED***
      // arrange
      var req, res, next;
      req = fakeRequest();
      res = fakeResponse();
      next = function () ***REMOVED***
        done();
      ***REMOVED***;

      // act
      cors()(req, res, next);
    ***REMOVED***);

    it('shortcircuits preflight requests', function (done) ***REMOVED***
      // arrange
      var req, res, next;
      req = fakeRequest();
      req.method = 'OPTIONS';
      res = fakeResponse();
      res.end = function () ***REMOVED***
        // assert
        res.statusCode.should.equal(204);
        done();
      ***REMOVED***;
      next = function () ***REMOVED***
        // assert
        done('should not be called');
      ***REMOVED***;

      // act
      cors()(req, res, next);
    ***REMOVED***);

    it('can configure preflight success response status code', function (done) ***REMOVED***
      // arrange
      var req, res, next;
      req = fakeRequest();
      req.method = 'OPTIONS';
      res = fakeResponse();
      res.end = function () ***REMOVED***
        // assert
        res.statusCode.should.equal(200);
        done();
      ***REMOVED***;
      next = function () ***REMOVED***
        // assert
        done('should not be called');
      ***REMOVED***;

      // act
      cors(***REMOVED***optionsSuccessStatus: 200***REMOVED***)(req, res, next);
    ***REMOVED***);

    it('doesn\'t shortcircuit preflight requests with preflightContinue option', function (done) ***REMOVED***
      // arrange
      var req, res, next;
      req = fakeRequest();
      req.method = 'OPTIONS';
      res = fakeResponse();
      res.end = function () ***REMOVED***
        // assert
        done('should not be called');
      ***REMOVED***;
      next = function () ***REMOVED***
        // assert
        done();
      ***REMOVED***;

      // act
      cors(***REMOVED***preflightContinue: true***REMOVED***)(req, res, next);
    ***REMOVED***);

    it('normalizes method names', function (done) ***REMOVED***
      // arrange
      var req, res, next;
      req = fakeRequest();
      req.method = 'options';
      res = fakeResponse();
      res.end = function () ***REMOVED***
        // assert
        res.statusCode.should.equal(204);
        done();
      ***REMOVED***;
      next = function () ***REMOVED***
        // assert
        done('should not be called');
      ***REMOVED***;

      // act
      cors()(req, res, next);
    ***REMOVED***);

    it('includes Content-Length response header', function (done) ***REMOVED***
      // arrange
      var req, res, next;
      req = fakeRequest();
      req.method = 'options';
      res = fakeResponse();
      res.end = function () ***REMOVED***
        // assert
        res.getHeader('Content-Length').should.equal('0');
        done();
      ***REMOVED***;
      next = function () ***REMOVED***
        // assert
        done('should not be called');
      ***REMOVED***;

      // act
      cors()(req, res, next);
    ***REMOVED***);

    it('no options enables default CORS to all origins', function (done) ***REMOVED***
      // arrange
      var req, res, next;
      req = fakeRequest();
      res = fakeResponse();
      next = function () ***REMOVED***
        // assert
        res.getHeader('Access-Control-Allow-Origin').should.equal('*');
        should.not.exist(res.getHeader('Access-Control-Allow-Methods'));
        done();
      ***REMOVED***;

      // act
      cors()(req, res, next);
    ***REMOVED***);

    it('OPTION call with no options enables default CORS to all origins and methods', function (done) ***REMOVED***
      // arrange
      var req, res, next;
      req = fakeRequest();
      req.method = 'OPTIONS';
      res = fakeResponse();
      res.end = function () ***REMOVED***
        // assert
        res.statusCode.should.equal(204);
        done();
      ***REMOVED***;
      next = function () ***REMOVED***
        // assert
        res.getHeader('Access-Control-Allow-Origin').should.equal('*');
        res.getHeader('Access-Control-Allow-Methods').should.equal('GET,PUT,PATCH,POST,DELETE');
        done();
      ***REMOVED***;

      // act
      cors()(req, res, next);
    ***REMOVED***);

    describe('passing static options', function () ***REMOVED***
      it('overrides defaults', function (done) ***REMOVED***
        // arrange
        var req, res, next, options;
        options = ***REMOVED***
          origin: 'example.com',
          methods: ['FOO', 'bar'],
          headers: ['FIZZ', 'buzz'],
          credentials: true,
          maxAge: 123
        ***REMOVED***;
        req = fakeRequest();
        req.method = 'OPTIONS';
        res = fakeResponse();
        res.end = function () ***REMOVED***
          // assert
          res.statusCode.should.equal(204);
          done();
        ***REMOVED***;
        next = function () ***REMOVED***
          // assert
          res.getHeader('Access-Control-Allow-Origin').should.equal('example.com');
          res.getHeader('Access-Control-Allow-Methods').should.equal('FOO,bar');
          res.getHeader('Access-Control-Allow-Headers').should.equal('FIZZ,buzz');
          res.getHeader('Access-Control-Allow-Credentials').should.equal('true');
          res.getHeader('Access-Control-Max-Age').should.equal('123');
          done();
        ***REMOVED***;

        // act
        cors(options)(req, res, next);
      ***REMOVED***);

      it('matches request origin against regexp', function(done) ***REMOVED***
        var req = fakeRequest();
        var res = fakeResponse();
        var options = ***REMOVED*** origin: /^(.+\.)?request.com$/ ***REMOVED***;
        cors(options)(req, res, function(err) ***REMOVED***
          should.not.exist(err);
          res.getHeader('Access-Control-Allow-Origin').should.equal(req.headers.origin);
          should.exist(res.getHeader('Vary'));
          res.getHeader('Vary').should.equal('Origin');
          return done();
        ***REMOVED***);
      ***REMOVED***);

      it('matches request origin against array of origin checks', function(done) ***REMOVED***
        var req = fakeRequest();
        var res = fakeResponse();
        var options = ***REMOVED*** origin: [ /foo\.com$/, 'request.com' ] ***REMOVED***;
        cors(options)(req, res, function(err) ***REMOVED***
          should.not.exist(err);
          res.getHeader('Access-Control-Allow-Origin').should.equal(req.headers.origin);
          should.exist(res.getHeader('Vary'));
          res.getHeader('Vary').should.equal('Origin');
          return done();
        ***REMOVED***);
      ***REMOVED***);

      it('doesn\'t match request origin against array of invalid origin checks', function(done) ***REMOVED***
        var req = fakeRequest();
        var res = fakeResponse();
        var options = ***REMOVED*** origin: [ /foo\.com$/, 'bar.com' ] ***REMOVED***;
        cors(options)(req, res, function(err) ***REMOVED***
          should.not.exist(err);
          should.not.exist(res.getHeader('Access-Control-Allow-Origin'));
          should.exist(res.getHeader('Vary'));
          res.getHeader('Vary').should.equal('Origin');
          return done();
        ***REMOVED***);
      ***REMOVED***);

      it('origin of false disables cors', function (done) ***REMOVED***
        // arrange
        var req, res, next, options;
        options = ***REMOVED***
          origin: false,
          methods: ['FOO', 'bar'],
          headers: ['FIZZ', 'buzz'],
          credentials: true,
          maxAge: 123
        ***REMOVED***;
        req = fakeRequest();
        res = fakeResponse();
        next = function () ***REMOVED***
          // assert
          should.not.exist(res.getHeader('Access-Control-Allow-Origin'));
          should.not.exist(res.getHeader('Access-Control-Allow-Methods'));
          should.not.exist(res.getHeader('Access-Control-Allow-Headers'));
          should.not.exist(res.getHeader('Access-Control-Allow-Credentials'));
          should.not.exist(res.getHeader('Access-Control-Max-Age'));
          done();
        ***REMOVED***;

        // act
        cors(options)(req, res, next);
      ***REMOVED***);

      it('can override origin', function (done) ***REMOVED***
        // arrange
        var req, res, next, options;
        options = ***REMOVED***
          origin: 'example.com'
        ***REMOVED***;
        req = fakeRequest();
        res = fakeResponse();
        next = function () ***REMOVED***
          // assert
          res.getHeader('Access-Control-Allow-Origin').should.equal('example.com');
          done();
        ***REMOVED***;

        // act
        cors(options)(req, res, next);
      ***REMOVED***);

      it('includes Vary header for specific origins', function (done) ***REMOVED***
        // arrange
        var req, res, next, options;
        options = ***REMOVED***
          origin: 'example.com'
        ***REMOVED***;
        req = fakeRequest();
        res = fakeResponse();
        next = function () ***REMOVED***
          // assert
          should.exist(res.getHeader('Vary'));
          res.getHeader('Vary').should.equal('Origin');
          done();
        ***REMOVED***;

        // act
        cors(options)(req, res, next);
      ***REMOVED***);

      it('appends to an existing Vary header', function (done) ***REMOVED***
        // arrange
        var req, res, next, options;
        options = ***REMOVED***
          origin: 'example.com'
        ***REMOVED***;
        req = fakeRequest();
        res = fakeResponse();
        res.setHeader('Vary', 'Foo');
        next = function () ***REMOVED***
          // assert
          res.getHeader('Vary').should.equal('Foo, Origin');
          done();
        ***REMOVED***;

        // act
        cors(options)(req, res, next);
      ***REMOVED***);

      it('origin defaults to *', function (done) ***REMOVED***
        // arrange
        var req, res, next, options;
        options = ***REMOVED***
        ***REMOVED***;
        req = fakeRequest();
        res = fakeResponse();
        next = function () ***REMOVED***
          // assert
          res.getHeader('Access-Control-Allow-Origin').should.equal('*');
          done();
        ***REMOVED***;

        // act
        cors(options)(req, res, next);
      ***REMOVED***);

      it('specifying true for origin reflects requesting origin', function (done) ***REMOVED***
        // arrange
        var req, res, next, options;
        options = ***REMOVED***
          origin: true
        ***REMOVED***;
        req = fakeRequest();
        res = fakeResponse();
        next = function () ***REMOVED***
          // assert
          res.getHeader('Access-Control-Allow-Origin').should.equal('request.com');
          done();
        ***REMOVED***;

        // act
        cors(options)(req, res, next);
      ***REMOVED***);

      it('should allow origin when callback returns true', function (done) ***REMOVED***
        var req, res, next, options;
        options = ***REMOVED***
          origin: function (sentOrigin, cb) ***REMOVED***
            sentOrigin.should.equal('request.com');
            cb(null, true);
          ***REMOVED***
        ***REMOVED***;
        req = fakeRequest();
        res = fakeResponse();
        next = function () ***REMOVED***
          res.getHeader('Access-Control-Allow-Origin').should.equal('request.com');
          done();
        ***REMOVED***;

        cors(options)(req, res, next);
      ***REMOVED***);

      it('should not allow origin when callback returns false', function (done) ***REMOVED***
        var req, res, next, options;
        options = ***REMOVED***
          origin: function (sentOrigin, cb) ***REMOVED***
            sentOrigin.should.equal('request.com');
            cb(null, false);
          ***REMOVED***
        ***REMOVED***;
        req = fakeRequest();
        res = fakeResponse();
        next = function () ***REMOVED***
          should.not.exist(res.getHeader('Access-Control-Allow-Origin'));
          should.not.exist(res.getHeader('Access-Control-Allow-Methods'));
          should.not.exist(res.getHeader('Access-Control-Allow-Headers'));
          should.not.exist(res.getHeader('Access-Control-Allow-Credentials'));
          should.not.exist(res.getHeader('Access-Control-Max-Age'));
          done();
        ***REMOVED***;

        cors(options)(req, res, next);
      ***REMOVED***);

      it('should not override options.origin callback', function (done) ***REMOVED***
        var req, res, next, options;
        options = ***REMOVED***
          origin: function (sentOrigin, cb) ***REMOVED***
            var isValid = sentOrigin === 'request.com';
            cb(null, isValid);
          ***REMOVED***
        ***REMOVED***;

        req = fakeRequest();
        res = fakeResponse();
        next = function () ***REMOVED***
          res.getHeader('Access-Control-Allow-Origin').should.equal('request.com');
        ***REMOVED***;

        cors(options)(req, res, next);

        req = fakeRequest(***REMOVED***
          'origin': 'invalid-request.com'
        ***REMOVED***);
        res = fakeResponse();

        next = function () ***REMOVED***
          should.not.exist(res.getHeader('Access-Control-Allow-Origin'));
          should.not.exist(res.getHeader('Access-Control-Allow-Methods'));
          should.not.exist(res.getHeader('Access-Control-Allow-Headers'));
          should.not.exist(res.getHeader('Access-Control-Allow-Credentials'));
          should.not.exist(res.getHeader('Access-Control-Max-Age'));
          done();
        ***REMOVED***;

        cors(options)(req, res, next);
      ***REMOVED***);


      it('can override methods', function (done) ***REMOVED***
        // arrange
        var req, res, next, options;
        options = ***REMOVED***
          methods: ['method1', 'method2']
        ***REMOVED***;
        req = fakeRequest();
        req.method = 'OPTIONS';
        res = fakeResponse();
        res.end = function () ***REMOVED***
          // assert
          res.statusCode.should.equal(204);
          done();
        ***REMOVED***;
        next = function () ***REMOVED***
          // assert
          res.getHeader('Access-Control-Allow-Methods').should.equal('method1,method2');
          done();
        ***REMOVED***;

        // act
        cors(options)(req, res, next);
      ***REMOVED***);

      it('methods defaults to GET, PUT, PATCH, POST, DELETE', function (done) ***REMOVED***
        // arrange
        var req, res, next, options;
        options = ***REMOVED***
        ***REMOVED***;
        req = fakeRequest();
        req.method = 'OPTIONS';
        res = fakeResponse();
        res.end = function () ***REMOVED***
          // assert
          res.statusCode.should.equal(204);
          done();
        ***REMOVED***;
        next = function () ***REMOVED***
          // assert
          res.getHeader('Access-Control-Allow-Methods').should.equal('GET,PUT,PATCH,POST,DELETE');
          done();
        ***REMOVED***;

        // act
        cors(options)(req, res, next);
      ***REMOVED***);

      it('can specify allowed headers', function (done) ***REMOVED***
        // arrange
        var req, res, options;
        options = ***REMOVED***
          allowedHeaders: ['header1', 'header2']
        ***REMOVED***;
        req = fakeRequest();
        req.method = 'OPTIONS';
        res = fakeResponse();
        res.end = function () ***REMOVED***
          // assert
          res.getHeader('Access-Control-Allow-Headers').should.equal('header1,header2');
          should.not.exist(res.getHeader('Vary'));
          done();
        ***REMOVED***;

        // act
        cors(options)(req, res, null);
      ***REMOVED***);

      it('specifying an empty list or string of allowed headers will result in no response header for allowed headers', function (done) ***REMOVED***
        // arrange
        var req, res, next, options;
        options = ***REMOVED***
          allowedHeaders: []
        ***REMOVED***;
        req = fakeRequest();
        res = fakeResponse();
        next = function () ***REMOVED***
          // assert
          should.not.exist(res.getHeader('Access-Control-Allow-Headers'));
          should.not.exist(res.getHeader('Vary'));
          done();
        ***REMOVED***;

        // act
        cors(options)(req, res, next);
      ***REMOVED***);

      it('if no allowed headers are specified, defaults to requested allowed headers', function (done) ***REMOVED***
        // arrange
        var req, res, options;
        options = ***REMOVED***
        ***REMOVED***;
        req = fakeRequest();
        req.method = 'OPTIONS';
        res = fakeResponse();
        res.end = function () ***REMOVED***
          // assert
          res.getHeader('Access-Control-Allow-Headers').should.equal('requestedHeader1,requestedHeader2');
          should.exist(res.getHeader('Vary'));
          res.getHeader('Vary').should.equal('Access-Control-Request-Headers');
          done();
        ***REMOVED***;

        // act
        cors(options)(req, res, null);
      ***REMOVED***);

      it('can specify exposed headers', function (done) ***REMOVED***
        // arrange
        var req, res, options, next;
        options = ***REMOVED***
          exposedHeaders: ['custom-header1', 'custom-header2']
        ***REMOVED***;
        req = fakeRequest();
        res = fakeResponse();
        next = function () ***REMOVED***
          // assert
          res.getHeader('Access-Control-Expose-Headers').should.equal('custom-header1,custom-header2');
          done();
        ***REMOVED***;

        // act
        cors(options)(req, res, next);
      ***REMOVED***);

      it('specifying an empty list or string of exposed headers will result in no response header for exposed headers', function (done) ***REMOVED***
        // arrange
        var req, res, next, options;
        options = ***REMOVED***
          exposedHeaders: []
        ***REMOVED***;
        req = fakeRequest();
        res = fakeResponse();
        next = function () ***REMOVED***
          // assert
          should.not.exist(res.getHeader('Access-Control-Expose-Headers'));
          done();
        ***REMOVED***;

        // act
        cors(options)(req, res, next);
      ***REMOVED***);

      it('includes credentials if explicitly enabled', function (done) ***REMOVED***
        // arrange
        var req, res, options;
        options = ***REMOVED***
          credentials: true
        ***REMOVED***;
        req = fakeRequest();
        req.method = 'OPTIONS';
        res = fakeResponse();
        res.end = function () ***REMOVED***
          // assert
          res.getHeader('Access-Control-Allow-Credentials').should.equal('true');
          done();
        ***REMOVED***;

        // act
        cors(options)(req, res, null);
      ***REMOVED***);

      it('does not includes credentials unless explicitly enabled', function (done) ***REMOVED***
        // arrange
        var req, res, next, options;
        options = ***REMOVED***
        ***REMOVED***;
        req = fakeRequest();
        res = fakeResponse();
        next = function () ***REMOVED***
          // assert
          should.not.exist(res.getHeader('Access-Control-Allow-Credentials'));
          done();
        ***REMOVED***;

        // act
        cors(options)(req, res, next);
      ***REMOVED***);

      it('includes maxAge when specified', function (done) ***REMOVED***
        // arrange
        var req, res, options;
        options = ***REMOVED***
          maxAge: 456
        ***REMOVED***;
        req = fakeRequest();
        req.method = 'OPTIONS';
        res = fakeResponse();
        res.end = function () ***REMOVED***
          // assert
          res.getHeader('Access-Control-Max-Age').should.equal('456');
          done();
        ***REMOVED***;

        // act
        cors(options)(req, res, null);
      ***REMOVED***);

      it('does not includes maxAge unless specified', function (done) ***REMOVED***
        // arrange
        var req, res, next, options;
        options = ***REMOVED***
        ***REMOVED***;
        req = fakeRequest();
        res = fakeResponse();
        next = function () ***REMOVED***
          // assert
          should.not.exist(res.getHeader('Access-Control-Max-Age'));
          done();
        ***REMOVED***;

        // act
        cors(options)(req, res, next);
      ***REMOVED***);
    ***REMOVED***);

    describe('passing a function to build options', function () ***REMOVED***
      it('handles options specified via callback', function (done) ***REMOVED***
        // arrange
        var req, res, next, delegate;
        delegate = function (req2, cb) ***REMOVED***
          cb(null, ***REMOVED***
            origin: 'delegate.com'
          ***REMOVED***);
        ***REMOVED***;
        req = fakeRequest();
        res = fakeResponse();
        next = function () ***REMOVED***
          // assert
          res.getHeader('Access-Control-Allow-Origin').should.equal('delegate.com');
          done();
        ***REMOVED***;

        // act
        cors(delegate)(req, res, next);
      ***REMOVED***);

      it('handles options specified via callback for preflight', function (done) ***REMOVED***
        // arrange
        var req, res, delegate;
        delegate = function (req2, cb) ***REMOVED***
          cb(null, ***REMOVED***
            origin: 'delegate.com',
            maxAge: 1000
          ***REMOVED***);
        ***REMOVED***;
        req = fakeRequest();
        req.method = 'OPTIONS';
        res = fakeResponse();
        res.end = function () ***REMOVED***
          // assert
          res.getHeader('Access-Control-Allow-Origin').should.equal('delegate.com');
          res.getHeader('Access-Control-Max-Age').should.equal('1000');
          done();
        ***REMOVED***;

        // act
        cors(delegate)(req, res, null);
      ***REMOVED***);

      it('handles error specified via callback', function (done) ***REMOVED***
        // arrange
        var req, res, next, delegate;
        delegate = function (req2, cb) ***REMOVED***
          cb('some error');
        ***REMOVED***;
        req = fakeRequest();
        res = fakeResponse();
        next = function (err) ***REMOVED***
          // assert
          err.should.equal('some error');
          done();
        ***REMOVED***;

        // act
        cors(delegate)(req, res, next);
      ***REMOVED***);
    ***REMOVED***);
  ***REMOVED***);

***REMOVED***());
