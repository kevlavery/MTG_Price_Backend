var path = require('path'),
  fs = require('fs'),
  f = require('util').format,
  resolveFrom = require('resolve-from'),
  semver = require('semver');

var exists = fs.existsSync || path.existsSync;

// Find the location of a package.json file near or above the given location
var find_package_json = function(location) ***REMOVED***
  var found = false;

  while(!found) ***REMOVED***
    if (exists(location + '/package.json')) ***REMOVED***
      found = location;
    ***REMOVED*** else if (location !== '/') ***REMOVED***
      location = path.dirname(location);
    ***REMOVED*** else ***REMOVED***
      return false;
    ***REMOVED***
  ***REMOVED***

  return location;
***REMOVED***

// Find the package.json object of the module closest up the module call tree that contains name in that module's peerOptionalDependencies
var find_package_json_with_name = function(name) ***REMOVED***
  // Walk up the module call tree until we find a module containing name in its peerOptionalDependencies
  var currentModule = module;
  var found = false;
  while (currentModule) ***REMOVED***
    // Check currentModule has a package.json
    location = currentModule.filename;
    var location = find_package_json(location)
    if (!location) ***REMOVED***
      currentModule = currentModule.parent;
      continue;
    ***REMOVED***

    // Read the package.json file
    var object = JSON.parse(fs.readFileSync(f('%s/package.json', location)));
    // Is the name defined by interal file references
    var parts = name.split(/\//);

    // Check whether this package.json contains peerOptionalDependencies containing the name we're searching for
    if (!object.peerOptionalDependencies || (object.peerOptionalDependencies && !object.peerOptionalDependencies[parts[0]])) ***REMOVED***
      currentModule = currentModule.parent;
      continue;
    ***REMOVED***
    found = true;
    break;
  ***REMOVED***

  // Check whether name has been found in currentModule's peerOptionalDependencies
  if (!found) ***REMOVED***
    throw new Error(f('no optional dependency [%s] defined in peerOptionalDependencies in any package.json', parts[0]));
  ***REMOVED***

  return ***REMOVED***
    object: object,
    parts: parts
  ***REMOVED***
***REMOVED***

var require_optional = function(name, options) ***REMOVED***
  options = options || ***REMOVED******REMOVED***;
  options.strict = typeof options.strict == 'boolean' ? options.strict : true;

  var res = find_package_json_with_name(name)
  var object = res.object;
  var parts = res.parts;

  // Unpack the expected version
  var expectedVersions = object.peerOptionalDependencies[parts[0]];
  // The resolved package
  var moduleEntry = undefined;
  // Module file
  var moduleEntryFile = name;

  try ***REMOVED***
    // Validate if it's possible to read the module
    moduleEntry = require(moduleEntryFile);
  ***REMOVED*** catch(err) ***REMOVED***
    // Attempt to resolve in top level package
    try ***REMOVED***
      // Get the module entry file
      moduleEntryFile = resolveFrom(process.cwd(), name);
      if(moduleEntryFile == null) return undefined;
      // Attempt to resolve the module
      moduleEntry = require(moduleEntryFile);
    ***REMOVED*** catch(err) ***REMOVED***
      if(err.code === 'MODULE_NOT_FOUND') return undefined;
    ***REMOVED***
  ***REMOVED***

  // Resolve the location of the module's package.json file
  var location = find_package_json(require.resolve(moduleEntryFile));
  if(!location) ***REMOVED***
    throw new Error('package.json can not be located');
  ***REMOVED***

  // Read the module file
  var dependentOnModule = JSON.parse(fs.readFileSync(f('%s/package.json', location)));
  // Get the version
  var version = dependentOnModule.version;
  // Validate if the found module satisfies the version id
  if(semver.satisfies(version, expectedVersions) == false
    && options.strict) ***REMOVED***
      var error = new Error(f('optional dependency [%s] found but version [%s] did not satisfy constraint [%s]', parts[0], version, expectedVersions));
      error.code = 'OPTIONAL_MODULE_NOT_FOUND';
      throw error;
  ***REMOVED***

  // Satifies the module requirement
  return moduleEntry;
***REMOVED***

require_optional.exists = function(name) ***REMOVED***
  try ***REMOVED***
    var m = require_optional(name);
    if(m === undefined) return false;
    return true;
  ***REMOVED*** catch(err) ***REMOVED***
    return false;
  ***REMOVED***
***REMOVED***

module.exports = require_optional;
