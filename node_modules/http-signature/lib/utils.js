// Copyright 2012 Joyent, Inc.  All rights reserved.

var assert = require('assert-plus');
var sshpk = require('sshpk');
var util = require('util');

var HASH_ALGOS = ***REMOVED***
  'sha1': true,
  'sha256': true,
  'sha512': true
***REMOVED***;

var PK_ALGOS = ***REMOVED***
  'rsa': true,
  'dsa': true,
  'ecdsa': true
***REMOVED***;

function HttpSignatureError(message, caller) ***REMOVED***
  if (Error.captureStackTrace)
    Error.captureStackTrace(this, caller || HttpSignatureError);

  this.message = message;
  this.name = caller.name;
***REMOVED***
util.inherits(HttpSignatureError, Error);

function InvalidAlgorithmError(message) ***REMOVED***
  HttpSignatureError.call(this, message, InvalidAlgorithmError);
***REMOVED***
util.inherits(InvalidAlgorithmError, HttpSignatureError);

function validateAlgorithm(algorithm) ***REMOVED***
  var alg = algorithm.toLowerCase().split('-');

  if (alg.length !== 2) ***REMOVED***
    throw (new InvalidAlgorithmError(alg[0].toUpperCase() + ' is not a ' +
      'valid algorithm'));
  ***REMOVED***

  if (alg[0] !== 'hmac' && !PK_ALGOS[alg[0]]) ***REMOVED***
    throw (new InvalidAlgorithmError(alg[0].toUpperCase() + ' type keys ' +
      'are not supported'));
  ***REMOVED***

  if (!HASH_ALGOS[alg[1]]) ***REMOVED***
    throw (new InvalidAlgorithmError(alg[1].toUpperCase() + ' is not a ' +
      'supported hash algorithm'));
  ***REMOVED***

  return (alg);
***REMOVED***

///--- API

module.exports = ***REMOVED***

  HASH_ALGOS: HASH_ALGOS,
  PK_ALGOS: PK_ALGOS,

  HttpSignatureError: HttpSignatureError,
  InvalidAlgorithmError: InvalidAlgorithmError,

  validateAlgorithm: validateAlgorithm,

  /**
   * Converts an OpenSSH public key (rsa only) to a PKCS#8 PEM file.
   *
   * The intent of this module is to interoperate with OpenSSL only,
   * specifically the node crypto module's `verify` method.
   *
   * @param ***REMOVED***String***REMOVED*** key an OpenSSH public key.
   * @return ***REMOVED***String***REMOVED*** PEM encoded form of the RSA public key.
   * @throws ***REMOVED***TypeError***REMOVED*** on bad input.
   * @throws ***REMOVED***Error***REMOVED*** on invalid ssh key formatted data.
   */
  sshKeyToPEM: function sshKeyToPEM(key) ***REMOVED***
    assert.string(key, 'ssh_key');

    var k = sshpk.parseKey(key, 'ssh');
    return (k.toString('pem'));
  ***REMOVED***,


  /**
   * Generates an OpenSSH fingerprint from an ssh public key.
   *
   * @param ***REMOVED***String***REMOVED*** key an OpenSSH public key.
   * @return ***REMOVED***String***REMOVED*** key fingerprint.
   * @throws ***REMOVED***TypeError***REMOVED*** on bad input.
   * @throws ***REMOVED***Error***REMOVED*** if what you passed doesn't look like an ssh public key.
   */
  fingerprint: function fingerprint(key) ***REMOVED***
    assert.string(key, 'ssh_key');

    var k = sshpk.parseKey(key, 'ssh');
    return (k.fingerprint('md5').toString('hex'));
  ***REMOVED***,

  /**
   * Converts a PKGCS#8 PEM file to an OpenSSH public key (rsa)
   *
   * The reverse of the above function.
   */
  pemToRsaSSHKey: function pemToRsaSSHKey(pem, comment) ***REMOVED***
    assert.equal('string', typeof (pem), 'typeof pem');

    var k = sshpk.parseKey(pem, 'pem');
    k.comment = comment;
    return (k.toString('ssh'));
  ***REMOVED***
***REMOVED***;
