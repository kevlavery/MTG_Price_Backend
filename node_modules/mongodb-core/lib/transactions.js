'use strict';
const MongoError = require('./error').MongoError;

let TxnState;
let stateMachine;

(() => ***REMOVED***
  const NO_TRANSACTION = 'NO_TRANSACTION';
  const STARTING_TRANSACTION = 'STARTING_TRANSACTION';
  const TRANSACTION_IN_PROGRESS = 'TRANSACTION_IN_PROGRESS';
  const TRANSACTION_COMMITTED = 'TRANSACTION_COMMITTED';
  const TRANSACTION_COMMITTED_EMPTY = 'TRANSACTION_COMMITTED_EMPTY';
  const TRANSACTION_ABORTED = 'TRANSACTION_ABORTED';

  TxnState = ***REMOVED***
    NO_TRANSACTION,
    STARTING_TRANSACTION,
    TRANSACTION_IN_PROGRESS,
    TRANSACTION_COMMITTED,
    TRANSACTION_COMMITTED_EMPTY,
    TRANSACTION_ABORTED
  ***REMOVED***;

  stateMachine = ***REMOVED***
    [NO_TRANSACTION]: [NO_TRANSACTION, STARTING_TRANSACTION],
    [STARTING_TRANSACTION]: [
      TRANSACTION_IN_PROGRESS,
      TRANSACTION_COMMITTED,
      TRANSACTION_COMMITTED_EMPTY,
      TRANSACTION_ABORTED
    ],
    [TRANSACTION_IN_PROGRESS]: [
      TRANSACTION_IN_PROGRESS,
      TRANSACTION_COMMITTED,
      TRANSACTION_ABORTED
    ],
    [TRANSACTION_COMMITTED]: [
      TRANSACTION_COMMITTED,
      TRANSACTION_COMMITTED_EMPTY,
      STARTING_TRANSACTION,
      NO_TRANSACTION
    ],
    [TRANSACTION_ABORTED]: [STARTING_TRANSACTION, NO_TRANSACTION],
    [TRANSACTION_COMMITTED_EMPTY]: [TRANSACTION_COMMITTED_EMPTY, NO_TRANSACTION]
  ***REMOVED***;
***REMOVED***)();

/**
 * A class maintaining state related to a server transaction
 */
class Transaction ***REMOVED***
  /**
   * Create a transaction
   *
   * @param ***REMOVED***object***REMOVED*** [options] Optional settings
   * @param ***REMOVED***string***REMOVED*** [options.readConcern] A default read concern for commands in this transaction
   * @param ***REMOVED***object***REMOVED*** [options.writeConcern] A default write concern for commands in this transaction
   * @param ***REMOVED***ReadPreference***REMOVED*** [options.readPreference] A default read preference for commands in this transaction
   */
  constructor(options) ***REMOVED***
    options = options || ***REMOVED******REMOVED***;

    this.state = TxnState.NO_TRANSACTION;
    this.options = ***REMOVED******REMOVED***;

    if (options.writeConcern || typeof options.w !== 'undefined') ***REMOVED***
      const w = options.writeConcern ? options.writeConcern.w : options.w;
      if (w <= 0) ***REMOVED***
        throw new MongoError('Transactions do not support unacknowledged write concern');
      ***REMOVED***

      this.options.writeConcern = options.writeConcern ? options.writeConcern : ***REMOVED*** w: options.w ***REMOVED***;
    ***REMOVED***

    if (options.readConcern) this.options.readConcern = options.readConcern;
    if (options.readPreference) this.options.readPreference = options.readPreference;
  ***REMOVED***

  /**
   * @return Whether this session is presently in a transaction
   */
  get isActive() ***REMOVED***
    return (
      [TxnState.STARTING_TRANSACTION, TxnState.TRANSACTION_IN_PROGRESS].indexOf(this.state) !== -1
    );
  ***REMOVED***

  /**
   * Transition the transaction in the state machine
   *
   * @param ***REMOVED***TxnState***REMOVED*** state The new state to transition to
   */
  transition(nextState) ***REMOVED***
    const nextStates = stateMachine[this.state];
    if (nextStates && nextStates.indexOf(nextState) !== -1) ***REMOVED***
      this.state = nextState;
      return;
    ***REMOVED***

    throw new MongoError(
      `Attempted illegal state transition from [$***REMOVED***this.state***REMOVED***] to [$***REMOVED***nextState***REMOVED***]`
    );
  ***REMOVED***
***REMOVED***

module.exports = ***REMOVED*** TxnState, Transaction ***REMOVED***;
