"use strict";
module.exports = function(Promise) ***REMOVED***
var util = require("./util");
var async = Promise._async;
var tryCatch = util.tryCatch;
var errorObj = util.errorObj;

function spreadAdapter(val, nodeback) ***REMOVED***
    var promise = this;
    if (!util.isArray(val)) return successAdapter.call(promise, val, nodeback);
    var ret =
        tryCatch(nodeback).apply(promise._boundValue(), [null].concat(val));
    if (ret === errorObj) ***REMOVED***
        async.throwLater(ret.e);
    ***REMOVED***
***REMOVED***

function successAdapter(val, nodeback) ***REMOVED***
    var promise = this;
    var receiver = promise._boundValue();
    var ret = val === undefined
        ? tryCatch(nodeback).call(receiver, null)
        : tryCatch(nodeback).call(receiver, null, val);
    if (ret === errorObj) ***REMOVED***
        async.throwLater(ret.e);
    ***REMOVED***
***REMOVED***
function errorAdapter(reason, nodeback) ***REMOVED***
    var promise = this;
    if (!reason) ***REMOVED***
        var newReason = new Error(reason + "");
        newReason.cause = reason;
        reason = newReason;
    ***REMOVED***
    var ret = tryCatch(nodeback).call(promise._boundValue(), reason);
    if (ret === errorObj) ***REMOVED***
        async.throwLater(ret.e);
    ***REMOVED***
***REMOVED***

Promise.prototype.asCallback = Promise.prototype.nodeify = function (nodeback,
                                                                     options) ***REMOVED***
    if (typeof nodeback == "function") ***REMOVED***
        var adapter = successAdapter;
        if (options !== undefined && Object(options).spread) ***REMOVED***
            adapter = spreadAdapter;
        ***REMOVED***
        this._then(
            adapter,
            errorAdapter,
            undefined,
            this,
            nodeback
        );
    ***REMOVED***
    return this;
***REMOVED***;
***REMOVED***;
