"use strict";
module.exports = function(Promise) ***REMOVED***
var longStackTraces = false;
var contextStack = [];

Promise.prototype._promiseCreated = function() ***REMOVED******REMOVED***;
Promise.prototype._pushContext = function() ***REMOVED******REMOVED***;
Promise.prototype._popContext = function() ***REMOVED***return null;***REMOVED***;
Promise._peekContext = Promise.prototype._peekContext = function() ***REMOVED******REMOVED***;

function Context() ***REMOVED***
    this._trace = new Context.CapturedTrace(peekContext());
***REMOVED***
Context.prototype._pushContext = function () ***REMOVED***
    if (this._trace !== undefined) ***REMOVED***
        this._trace._promiseCreated = null;
        contextStack.push(this._trace);
    ***REMOVED***
***REMOVED***;

Context.prototype._popContext = function () ***REMOVED***
    if (this._trace !== undefined) ***REMOVED***
        var trace = contextStack.pop();
        var ret = trace._promiseCreated;
        trace._promiseCreated = null;
        return ret;
    ***REMOVED***
    return null;
***REMOVED***;

function createContext() ***REMOVED***
    if (longStackTraces) return new Context();
***REMOVED***

function peekContext() ***REMOVED***
    var lastIndex = contextStack.length - 1;
    if (lastIndex >= 0) ***REMOVED***
        return contextStack[lastIndex];
    ***REMOVED***
    return undefined;
***REMOVED***
Context.CapturedTrace = null;
Context.create = createContext;
Context.deactivateLongStackTraces = function() ***REMOVED******REMOVED***;
Context.activateLongStackTraces = function() ***REMOVED***
    var Promise_pushContext = Promise.prototype._pushContext;
    var Promise_popContext = Promise.prototype._popContext;
    var Promise_PeekContext = Promise._peekContext;
    var Promise_peekContext = Promise.prototype._peekContext;
    var Promise_promiseCreated = Promise.prototype._promiseCreated;
    Context.deactivateLongStackTraces = function() ***REMOVED***
        Promise.prototype._pushContext = Promise_pushContext;
        Promise.prototype._popContext = Promise_popContext;
        Promise._peekContext = Promise_PeekContext;
        Promise.prototype._peekContext = Promise_peekContext;
        Promise.prototype._promiseCreated = Promise_promiseCreated;
        longStackTraces = false;
    ***REMOVED***;
    longStackTraces = true;
    Promise.prototype._pushContext = Context.prototype._pushContext;
    Promise.prototype._popContext = Context.prototype._popContext;
    Promise._peekContext = Promise.prototype._peekContext = peekContext;
    Promise.prototype._promiseCreated = function() ***REMOVED***
        var ctx = this._peekContext();
        if (ctx && ctx._promiseCreated == null) ctx._promiseCreated = this;
    ***REMOVED***;
***REMOVED***;
return Context;
***REMOVED***;
