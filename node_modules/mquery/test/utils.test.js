
var utils = require('../lib/utils');
var assert = require('assert');

var mongo;
try ***REMOVED***
  mongo = new require('mongodb');
***REMOVED*** catch (e) ***REMOVED******REMOVED***

describe('lib/utils', function() ***REMOVED***
  describe('clone', function() ***REMOVED***
    it('clones constructors named ObjectId', function(done) ***REMOVED***
      function ObjectId (id) ***REMOVED***
        this.id = id;
      ***REMOVED***

      var o1 = new ObjectId('1234');
      var o2 = utils.clone(o1);
      assert.ok(o2 instanceof ObjectId);

      done();
    ***REMOVED***);

    it('clones constructors named ObjectID', function(done) ***REMOVED***
      function ObjectID (id) ***REMOVED***
        this.id = id;
      ***REMOVED***

      var o1 = new ObjectID('1234');
      var o2 = utils.clone(o1);

      assert.ok(o2 instanceof ObjectID);
      done();
    ***REMOVED***);

    it('does not clone constructors named ObjectIdd', function(done) ***REMOVED***
      function ObjectIdd (id) ***REMOVED***
        this.id = id;
      ***REMOVED***

      var o1 = new ObjectIdd('1234');
      var o2 = utils.clone(o1);
      assert.ok(!(o2 instanceof ObjectIdd));

      done();
    ***REMOVED***);

    it('optionally clones ObjectId constructors using its clone method', function(done) ***REMOVED***
      function ObjectID (id) ***REMOVED***
        this.id = id;
        this.cloned = false;
      ***REMOVED***

      ObjectID.prototype.clone = function () ***REMOVED***
        var ret = new ObjectID(this.id);
        ret.cloned = true;
        return ret;
      ***REMOVED***

      var id = 1234;
      var o1 = new ObjectID(id);
      assert.equal(id, o1.id);
      assert.equal(false, o1.cloned);

      var o2 = utils.clone(o1);
      assert.ok(o2 instanceof ObjectID);
      assert.equal(id, o2.id);
      assert.ok(o2.cloned);
      done();
    ***REMOVED***);

    it('clones mongodb.ReadPreferences', function (done) ***REMOVED***
      if (!mongo) return done();

      var tags = [
        ***REMOVED***dc: 'tag1'***REMOVED***
      ];
      var prefs = [
        new mongo.ReadPreference("primary"),
        new mongo.ReadPreference(mongo.ReadPreference.PRIMARY_PREFERRED),
        new mongo.ReadPreference("primary", tags),
        mongo.ReadPreference("primary", tags)
      ];

      var prefsCloned = utils.clone(prefs);

      for (var i = 0; i < prefsCloned.length; i++) ***REMOVED***
        assert.notEqual(prefs[i], prefsCloned[i]);
        assert.ok(prefsCloned[i] instanceof mongo.ReadPreference);
        assert.ok(prefsCloned[i].isValid());
        if (prefs[i].tags) ***REMOVED***
          assert.ok(prefsCloned[i].tags);
          assert.notEqual(prefs[i].tags, prefsCloned[i].tags);
          assert.notEqual(prefs[i].tags[0], prefsCloned[i].tags[0]);
        ***REMOVED*** else ***REMOVED***
          assert.equal(prefsCloned[i].tags, null);
        ***REMOVED***
      ***REMOVED***

      done();
    ***REMOVED***);

    it('clones mongodb.Binary', function(done)***REMOVED***
      if (!mongo) return done();

      var buf = new Buffer('hi');
      var binary= new mongo.Binary(buf, 2);
      var clone = utils.clone(binary);
      assert.equal(binary.sub_type, clone.sub_type);
      assert.equal(String(binary.buffer), String(buf));
      assert.ok(binary !== clone);
      done();
    ***REMOVED***)

    it('handles objects with no constructor', function(done) ***REMOVED***
      var name ='335';

      var o = Object.create(null);
      o.name = name;

      var clone;
      assert.doesNotThrow(function() ***REMOVED***
        clone = utils.clone(o);
      ***REMOVED***);

      assert.equal(name, clone.name);
      assert.ok(o != clone);
      done();
    ***REMOVED***);

    it('handles buffers', function(done)***REMOVED***
      var buff = new Buffer(10);
      buff.fill(1);
      var clone = utils.clone(buff);

      for (var i = 0; i < buff.length; i++) ***REMOVED***
        assert.equal(buff[i], clone[i]);
      ***REMOVED***

      done();
    ***REMOVED***);
  ***REMOVED***);
***REMOVED***);
