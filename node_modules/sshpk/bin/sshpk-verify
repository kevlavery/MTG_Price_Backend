#!/usr/bin/env node
// -*- mode: js -*-
// vim: set filetype=javascript :
// Copyright 2015 Joyent, Inc.  All rights reserved.

var dashdash = require('dashdash');
var sshpk = require('../lib/index');
var fs = require('fs');
var path = require('path');

var options = [
	***REMOVED***
		names: ['hash', 'H'],
		type: 'string',
		help: 'Hash algorithm (sha1, sha256, sha384, sha512)'
	***REMOVED***,
	***REMOVED***
		names: ['verbose', 'v'],
		type: 'bool',
		help: 'Display verbose info about key and hash used'
	***REMOVED***,
	***REMOVED***
		names: ['identity', 'i'],
		type: 'string',
		help: 'Path to (public) key to use'
	***REMOVED***,
	***REMOVED***
		names: ['file', 'f'],
		type: 'string',
		help: 'Input filename'
	***REMOVED***,
	***REMOVED***
		names: ['format', 't'],
		type: 'string',
		help: 'Signature format (asn1, ssh, raw)'
	***REMOVED***,
	***REMOVED***
		names: ['signature', 's'],
		type: 'string',
		help: 'base64-encoded signature data'
	***REMOVED***,
	***REMOVED***
		names: ['help', 'h'],
		type: 'bool',
		help: 'Shows this help text'
	***REMOVED***
];

if (require.main === module) ***REMOVED***
	var parser = dashdash.createParser(***REMOVED***
		options: options
	***REMOVED***);

	try ***REMOVED***
		var opts = parser.parse(process.argv);
	***REMOVED*** catch (e) ***REMOVED***
		console.error('sshpk-verify: error: %s', e.message);
		process.exit(3);
	***REMOVED***

	if (opts.help || opts._args.length > 1) ***REMOVED***
		var help = parser.help(***REMOVED******REMOVED***).trimRight();
		console.error('sshpk-verify: sign data using an SSH key\n');
		console.error(help);
		process.exit(3);
	***REMOVED***

	if (!opts.identity) ***REMOVED***
		var help = parser.help(***REMOVED******REMOVED***).trimRight();
		console.error('sshpk-verify: the -i or --identity option ' +
		    'is required\n');
		console.error(help);
		process.exit(3);
	***REMOVED***

	if (!opts.signature) ***REMOVED***
		var help = parser.help(***REMOVED******REMOVED***).trimRight();
		console.error('sshpk-verify: the -s or --signature option ' +
		    'is required\n');
		console.error(help);
		process.exit(3);
	***REMOVED***

	var keyData = fs.readFileSync(opts.identity);

	var key;
	try ***REMOVED***
		key = sshpk.parseKey(keyData);
	***REMOVED*** catch (e) ***REMOVED***
		console.error('sshpk-verify: error loading key "' +
		    opts.identity + '": ' + e.name + ': ' + e.message);
		process.exit(2);
	***REMOVED***

	var fmt = opts.format || 'asn1';
	var sigData = new Buffer(opts.signature, 'base64');

	var sig;
	try ***REMOVED***
		sig = sshpk.parseSignature(sigData, key.type, fmt);
	***REMOVED*** catch (e) ***REMOVED***
		console.error('sshpk-verify: error parsing signature: ' +
		    e.name + ': ' + e.message);
		process.exit(2);
	***REMOVED***

	var hash = opts.hash || key.defaultHashAlgorithm();

	var verifier;
	try ***REMOVED***
		verifier = key.createVerify(hash);
	***REMOVED*** catch (e) ***REMOVED***
		console.error('sshpk-verify: error creating verifier: ' +
		    e.name + ': ' + e.message);
		process.exit(2);
	***REMOVED***

	if (opts.verbose) ***REMOVED***
		console.error('sshpk-verify: using %s-%s with a %d bit key',
		    key.type, hash, key.size);
	***REMOVED***

	var inFile = process.stdin;
	var inFileName = 'stdin';

	var inFilePath;
	if (opts.file) ***REMOVED***
		inFilePath = opts.file;
	***REMOVED*** else if (opts._args.length === 1) ***REMOVED***
		inFilePath = opts._args[0];
	***REMOVED***

	if (inFilePath)
		inFileName = path.basename(inFilePath);

	try ***REMOVED***
		if (inFilePath) ***REMOVED***
			fs.accessSync(inFilePath, fs.R_OK);
			inFile = fs.createReadStream(inFilePath);
		***REMOVED***
	***REMOVED*** catch (e) ***REMOVED***
		console.error('sshpk-verify: error opening input file' +
		     ': ' + e.name + ': ' + e.message);
		process.exit(2);
	***REMOVED***

	inFile.pipe(verifier);
	inFile.on('end', function () ***REMOVED***
		var ret;
		try ***REMOVED***
			ret = verifier.verify(sig);
		***REMOVED*** catch (e) ***REMOVED***
			console.error('sshpk-verify: error verifying data: ' +
			    e.name + ': ' + e.message);
			process.exit(1);
		***REMOVED***

		if (ret) ***REMOVED***
			console.error('OK');
			process.exit(0);
		***REMOVED***

		console.error('NOT OK');
		process.exit(1);
	***REMOVED***);
***REMOVED***
