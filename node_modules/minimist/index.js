module.exports = function (args, opts) ***REMOVED***
    if (!opts) opts = ***REMOVED******REMOVED***;
    
    var flags = ***REMOVED*** bools : ***REMOVED******REMOVED***, strings : ***REMOVED******REMOVED*** ***REMOVED***;
    
    [].concat(opts['boolean']).filter(Boolean).forEach(function (key) ***REMOVED***
        flags.bools[key] = true;
    ***REMOVED***);
    
    var aliases = ***REMOVED******REMOVED***;
    Object.keys(opts.alias || ***REMOVED******REMOVED***).forEach(function (key) ***REMOVED***
        aliases[key] = [].concat(opts.alias[key]);
        aliases[key].forEach(function (x) ***REMOVED***
            aliases[x] = [key].concat(aliases[key].filter(function (y) ***REMOVED***
                return x !== y;
            ***REMOVED***));
        ***REMOVED***);
    ***REMOVED***);

    [].concat(opts.string).filter(Boolean).forEach(function (key) ***REMOVED***
        flags.strings[key] = true;
        if (aliases[key]) ***REMOVED***
            flags.strings[aliases[key]] = true;
        ***REMOVED***
     ***REMOVED***);

    var defaults = opts['default'] || ***REMOVED******REMOVED***;
    
    var argv = ***REMOVED*** _ : [] ***REMOVED***;
    Object.keys(flags.bools).forEach(function (key) ***REMOVED***
        setArg(key, defaults[key] === undefined ? false : defaults[key]);
    ***REMOVED***);
    
    var notFlags = [];

    if (args.indexOf('--') !== -1) ***REMOVED***
        notFlags = args.slice(args.indexOf('--')+1);
        args = args.slice(0, args.indexOf('--'));
    ***REMOVED***

    function setArg (key, val) ***REMOVED***
        var value = !flags.strings[key] && isNumber(val)
            ? Number(val) : val
        ;
        setKey(argv, key.split('.'), value);
        
        (aliases[key] || []).forEach(function (x) ***REMOVED***
            setKey(argv, x.split('.'), value);
        ***REMOVED***);
    ***REMOVED***
    
    for (var i = 0; i < args.length; i++) ***REMOVED***
        var arg = args[i];
        
        if (/^--.+=/.test(arg)) ***REMOVED***
            // Using [\s\S] instead of . because js doesn't support the
            // 'dotall' regex modifier. See:
            // http://stackoverflow.com/a/1068308/13216
            var m = arg.match(/^--([^=]+)=([\s\S]*)$/);
            setArg(m[1], m[2]);
        ***REMOVED***
        else if (/^--no-.+/.test(arg)) ***REMOVED***
            var key = arg.match(/^--no-(.+)/)[1];
            setArg(key, false);
        ***REMOVED***
        else if (/^--.+/.test(arg)) ***REMOVED***
            var key = arg.match(/^--(.+)/)[1];
            var next = args[i + 1];
            if (next !== undefined && !/^-/.test(next)
            && !flags.bools[key]
            && (aliases[key] ? !flags.bools[aliases[key]] : true)) ***REMOVED***
                setArg(key, next);
                i++;
            ***REMOVED***
            else if (/^(true|false)$/.test(next)) ***REMOVED***
                setArg(key, next === 'true');
                i++;
            ***REMOVED***
            else ***REMOVED***
                setArg(key, flags.strings[key] ? '' : true);
            ***REMOVED***
        ***REMOVED***
        else if (/^-[^-]+/.test(arg)) ***REMOVED***
            var letters = arg.slice(1,-1).split('');
            
            var broken = false;
            for (var j = 0; j < letters.length; j++) ***REMOVED***
                var next = arg.slice(j+2);
                
                if (next === '-') ***REMOVED***
                    setArg(letters[j], next)
                    continue;
                ***REMOVED***
                
                if (/[A-Za-z]/.test(letters[j])
                && /-?\d+(\.\d*)?(e-?\d+)?$/.test(next)) ***REMOVED***
                    setArg(letters[j], next);
                    broken = true;
                    break;
                ***REMOVED***
                
                if (letters[j+1] && letters[j+1].match(/\W/)) ***REMOVED***
                    setArg(letters[j], arg.slice(j+2));
                    broken = true;
                    break;
                ***REMOVED***
                else ***REMOVED***
                    setArg(letters[j], flags.strings[letters[j]] ? '' : true);
                ***REMOVED***
            ***REMOVED***
            
            var key = arg.slice(-1)[0];
            if (!broken && key !== '-') ***REMOVED***
                if (args[i+1] && !/^(-|--)[^-]/.test(args[i+1])
                && !flags.bools[key]
                && (aliases[key] ? !flags.bools[aliases[key]] : true)) ***REMOVED***
                    setArg(key, args[i+1]);
                    i++;
                ***REMOVED***
                else if (args[i+1] && /true|false/.test(args[i+1])) ***REMOVED***
                    setArg(key, args[i+1] === 'true');
                    i++;
                ***REMOVED***
                else ***REMOVED***
                    setArg(key, flags.strings[key] ? '' : true);
                ***REMOVED***
            ***REMOVED***
        ***REMOVED***
        else ***REMOVED***
            argv._.push(
                flags.strings['_'] || !isNumber(arg) ? arg : Number(arg)
            );
        ***REMOVED***
    ***REMOVED***
    
    Object.keys(defaults).forEach(function (key) ***REMOVED***
        if (!hasKey(argv, key.split('.'))) ***REMOVED***
            setKey(argv, key.split('.'), defaults[key]);
            
            (aliases[key] || []).forEach(function (x) ***REMOVED***
                setKey(argv, x.split('.'), defaults[key]);
            ***REMOVED***);
        ***REMOVED***
    ***REMOVED***);
    
    notFlags.forEach(function(key) ***REMOVED***
        argv._.push(key);
    ***REMOVED***);

    return argv;
***REMOVED***;

function hasKey (obj, keys) ***REMOVED***
    var o = obj;
    keys.slice(0,-1).forEach(function (key) ***REMOVED***
        o = (o[key] || ***REMOVED******REMOVED***);
    ***REMOVED***);

    var key = keys[keys.length - 1];
    return key in o;
***REMOVED***

function setKey (obj, keys, value) ***REMOVED***
    var o = obj;
    keys.slice(0,-1).forEach(function (key) ***REMOVED***
        if (o[key] === undefined) o[key] = ***REMOVED******REMOVED***;
        o = o[key];
    ***REMOVED***);
    
    var key = keys[keys.length - 1];
    if (o[key] === undefined || typeof o[key] === 'boolean') ***REMOVED***
        o[key] = value;
    ***REMOVED***
    else if (Array.isArray(o[key])) ***REMOVED***
        o[key].push(value);
    ***REMOVED***
    else ***REMOVED***
        o[key] = [ o[key], value ];
    ***REMOVED***
***REMOVED***

function isNumber (x) ***REMOVED***
    if (typeof x === 'number') return true;
    if (/^0x[0-9a-f]+$/i.test(x)) return true;
    return /^[-+]?(?:\d+(?:\.\d*)?|\.\d+)(e[-+]?\d+)?$/.test(x);
***REMOVED***

