var assert = require('assert');
var Kareem = require('../');

/* Much like [hooks](https://npmjs.org/package/hooks), kareem lets you define
 * pre and post hooks: pre hooks are called before a given function executes.
 * Unlike hooks, kareem stores hooks and other internal state in a separate
 * object, rather than relying on inheritance. Furthermore, kareem exposes
 * an `execPre()` function that allows you to execute your pre hooks when
 * appropriate, giving you more fine-grained control over your function hooks.
 */
describe('pre hooks', function() ***REMOVED***
  var hooks;

  beforeEach(function() ***REMOVED***
    hooks = new Kareem();
  ***REMOVED***);

  it('runs without any hooks specified', function(done) ***REMOVED***
    hooks.execPre('cook', null, function() ***REMOVED***
      done();
    ***REMOVED***);
  ***REMOVED***);

  /* pre hook functions take one parameter, a "done" function that you execute
   * when your pre hook is finished.
   */
  it('runs basic serial pre hooks', function(done) ***REMOVED***
    var count = 0;

    hooks.pre('cook', function(done) ***REMOVED***
      ++count;
      done();
    ***REMOVED***);

    hooks.execPre('cook', null, function() ***REMOVED***
      assert.equal(1, count);
      done();
    ***REMOVED***);
  ***REMOVED***);

  it('can run multipe pre hooks', function(done) ***REMOVED***
    var count1 = 0;
    var count2 = 0;

    hooks.pre('cook', function(done) ***REMOVED***
      ++count1;
      done();
    ***REMOVED***);

    hooks.pre('cook', function(done) ***REMOVED***
      ++count2;
      done();
    ***REMOVED***);

    hooks.execPre('cook', null, function() ***REMOVED***
      assert.equal(1, count1);
      assert.equal(1, count2);
      done();
    ***REMOVED***);
  ***REMOVED***);

  /* If your pre hook function takes no parameters, its assumed to be
   * fully synchronous.
   */
  it('can run fully synchronous pre hooks', function(done) ***REMOVED***
    var count1 = 0;
    var count2 = 0;

    hooks.pre('cook', function() ***REMOVED***
      ++count1;
    ***REMOVED***);

    hooks.pre('cook', function() ***REMOVED***
      ++count2;
    ***REMOVED***);

    hooks.execPre('cook', null, function(error) ***REMOVED***
      assert.equal(null, error);
      assert.equal(1, count1);
      assert.equal(1, count2);
      done();
    ***REMOVED***);
  ***REMOVED***);

  /* Pre save hook functions are bound to the second parameter to `execPre()`
   */
  it('properly attaches context to pre hooks', function(done) ***REMOVED***
    hooks.pre('cook', function(done) ***REMOVED***
      this.bacon = 3;
      done();
    ***REMOVED***);

    hooks.pre('cook', function(done) ***REMOVED***
      this.eggs = 4;
      done();
    ***REMOVED***);

    var obj = ***REMOVED*** bacon: 0, eggs: 0 ***REMOVED***;

    // In the pre hooks, `this` will refer to `obj`
    hooks.execPre('cook', obj, function(error) ***REMOVED***
      assert.equal(null, error);
      assert.equal(3, obj.bacon);
      assert.equal(4, obj.eggs);
      done();
    ***REMOVED***);
  ***REMOVED***);

  /* Like the hooks module, you can declare "async" pre hooks - these take two
   * parameters, the functions `next()` and `done()`. `next()` passes control to
   * the next pre hook, but the underlying function won't be called until all
   * async pre hooks have called `done()`.
   */
  it('can execute parallel (async) pre hooks', function(done) ***REMOVED***
    hooks.pre('cook', true, function(next, done) ***REMOVED***
      this.bacon = 3;
      next();
      setTimeout(function() ***REMOVED***
        done();
      ***REMOVED***, 5);
    ***REMOVED***);

    hooks.pre('cook', true, function(next, done) ***REMOVED***
      next();
      var _this = this;
      setTimeout(function() ***REMOVED***
        _this.eggs = 4;
        done();
      ***REMOVED***, 10);
    ***REMOVED***);

    hooks.pre('cook', function(next) ***REMOVED***
      this.waffles = false;
      next();
    ***REMOVED***);

    var obj = ***REMOVED*** bacon: 0, eggs: 0 ***REMOVED***;

    hooks.execPre('cook', obj, function() ***REMOVED***
      assert.equal(3, obj.bacon);
      assert.equal(4, obj.eggs);
      assert.equal(false, obj.waffles);
      done();
    ***REMOVED***);
  ***REMOVED***);

  /* You can also return a promise from your pre hooks instead of calling
   * `next()`. When the returned promise resolves, kareem will kick off the
   * next middleware.
   */
  it('supports returning a promise', function(done) ***REMOVED***
    hooks.pre('cook', function() ***REMOVED***
      return new Promise(resolve => ***REMOVED***
        setTimeout(() => ***REMOVED***
          this.bacon = 3;
          resolve();
        ***REMOVED***, 100);
      ***REMOVED***);
    ***REMOVED***);

    var obj = ***REMOVED*** bacon: 0 ***REMOVED***;

    hooks.execPre('cook', obj, function() ***REMOVED***
      assert.equal(3, obj.bacon);
      done();
    ***REMOVED***);
  ***REMOVED***);
***REMOVED***);

describe('post hooks', function() ***REMOVED***
  var hooks;

  beforeEach(function() ***REMOVED***
    hooks = new Kareem();
  ***REMOVED***);

  it('runs without any hooks specified', function(done) ***REMOVED***
    hooks.execPost('cook', null, [1], function(error, eggs) ***REMOVED***
      assert.ifError(error);
      assert.equal(1, eggs);
      done();
    ***REMOVED***);
  ***REMOVED***);

  it('executes with parameters passed in', function(done) ***REMOVED***
    hooks.post('cook', function(eggs, bacon, callback) ***REMOVED***
      assert.equal(1, eggs);
      assert.equal(2, bacon);
      callback();
    ***REMOVED***);

    hooks.execPost('cook', null, [1, 2], function(error, eggs, bacon) ***REMOVED***
      assert.ifError(error);
      assert.equal(1, eggs);
      assert.equal(2, bacon);
      done();
    ***REMOVED***);
  ***REMOVED***);

  it('can use synchronous post hooks', function(done) ***REMOVED***
    var execed = ***REMOVED******REMOVED***;

    hooks.post('cook', function(eggs, bacon) ***REMOVED***
      execed.first = true;
      assert.equal(1, eggs);
      assert.equal(2, bacon);
    ***REMOVED***);

    hooks.post('cook', function(eggs, bacon, callback) ***REMOVED***
      execed.second = true;
      assert.equal(1, eggs);
      assert.equal(2, bacon);
      callback();
    ***REMOVED***);

    hooks.execPost('cook', null, [1, 2], function(error, eggs, bacon) ***REMOVED***
      assert.ifError(error);
      assert.equal(2, Object.keys(execed).length);
      assert.ok(execed.first);
      assert.ok(execed.second);
      assert.equal(1, eggs);
      assert.equal(2, bacon);
      done();
    ***REMOVED***);
  ***REMOVED***);
***REMOVED***);

describe('wrap()', function() ***REMOVED***
  var hooks;

  beforeEach(function() ***REMOVED***
    hooks = new Kareem();
  ***REMOVED***);

  it('wraps pre and post calls into one call', function(done) ***REMOVED***
    hooks.pre('cook', true, function(next, done) ***REMOVED***
      this.bacon = 3;
      next();
      setTimeout(function() ***REMOVED***
        done();
      ***REMOVED***, 5);
    ***REMOVED***);

    hooks.pre('cook', true, function(next, done) ***REMOVED***
      next();
      var _this = this;
      setTimeout(function() ***REMOVED***
        _this.eggs = 4;
        done();
      ***REMOVED***, 10);
    ***REMOVED***);

    hooks.pre('cook', function(next) ***REMOVED***
      this.waffles = false;
      next();
    ***REMOVED***);

    hooks.post('cook', function(obj) ***REMOVED***
      obj.tofu = 'no';
    ***REMOVED***);

    var obj = ***REMOVED*** bacon: 0, eggs: 0 ***REMOVED***;

    var args = [obj];
    args.push(function(error, result) ***REMOVED***
      assert.ifError(error);
      assert.equal(null, error);
      assert.equal(3, obj.bacon);
      assert.equal(4, obj.eggs);
      assert.equal(false, obj.waffles);
      assert.equal('no', obj.tofu);

      assert.equal(obj, result);
      done();
    ***REMOVED***);

    hooks.wrap(
      'cook',
      function(o, callback) ***REMOVED***
        assert.equal(3, obj.bacon);
        assert.equal(4, obj.eggs);
        assert.equal(false, obj.waffles);
        assert.equal(undefined, obj.tofu);
        callback(null, o);
      ***REMOVED***,
      obj,
      args);
  ***REMOVED***);
***REMOVED***);

describe('createWrapper()', function() ***REMOVED***
  var hooks;

  beforeEach(function() ***REMOVED***
    hooks = new Kareem();
  ***REMOVED***);

  it('wraps wrap() into a callable function', function(done) ***REMOVED***
    hooks.pre('cook', true, function(next, done) ***REMOVED***
      this.bacon = 3;
      next();
      setTimeout(function() ***REMOVED***
        done();
      ***REMOVED***, 5);
    ***REMOVED***);

    hooks.pre('cook', true, function(next, done) ***REMOVED***
      next();
      var _this = this;
      setTimeout(function() ***REMOVED***
        _this.eggs = 4;
        done();
      ***REMOVED***, 10);
    ***REMOVED***);

    hooks.pre('cook', function(next) ***REMOVED***
      this.waffles = false;
      next();
    ***REMOVED***);

    hooks.post('cook', function(obj) ***REMOVED***
      obj.tofu = 'no';
    ***REMOVED***);

    var obj = ***REMOVED*** bacon: 0, eggs: 0 ***REMOVED***;

    var cook = hooks.createWrapper(
      'cook',
      function(o, callback) ***REMOVED***
        assert.equal(3, obj.bacon);
        assert.equal(4, obj.eggs);
        assert.equal(false, obj.waffles);
        assert.equal(undefined, obj.tofu);
        callback(null, o);
      ***REMOVED***,
      obj);

    cook(obj, function(error, result) ***REMOVED***
      assert.ifError(error);
      assert.equal(3, obj.bacon);
      assert.equal(4, obj.eggs);
      assert.equal(false, obj.waffles);
      assert.equal('no', obj.tofu);

      assert.equal(obj, result);
      done();
    ***REMOVED***);
  ***REMOVED***);
***REMOVED***);

describe('clone()', function() ***REMOVED***
  it('clones a Kareem object', function() ***REMOVED***
    var k1 = new Kareem();
    k1.pre('cook', function() ***REMOVED******REMOVED***);
    k1.post('cook', function() ***REMOVED******REMOVED***);

    var k2 = k1.clone();
    assert.deepEqual(['cook'], Object.keys(k2._pres));
    assert.deepEqual(['cook'], Object.keys(k2._posts));
  ***REMOVED***);
***REMOVED***);

describe('merge()', function() ***REMOVED***
  it('pulls hooks from another Kareem object', function() ***REMOVED***
    var k1 = new Kareem();
    var test1 = function() ***REMOVED******REMOVED***;
    k1.pre('cook', test1);
    k1.post('cook', function() ***REMOVED******REMOVED***);

    var k2 = new Kareem();
    var test2 = function() ***REMOVED******REMOVED***;
    k2.pre('cook', test2);
    var k3 = k2.merge(k1);
    assert.equal(k3._pres['cook'].length, 2);
    assert.equal(k3._pres['cook'][0].fn, test2);
    assert.equal(k3._pres['cook'][1].fn, test1);
    assert.equal(k3._posts['cook'].length, 1);
  ***REMOVED***);
***REMOVED***);
