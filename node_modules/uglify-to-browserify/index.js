'use strict'

var fs = require('fs')
var PassThrough = require('stream').PassThrough
var Transform = require('stream').Transform

if (typeof Transform === 'undefined') ***REMOVED***
  throw new Error('UglifyJS only supports browserify when using node >= 0.10.x')
***REMOVED***

var cache = ***REMOVED******REMOVED***
module.exports = transform
function transform(file) ***REMOVED***
  if (!/tools\/node\.js$/.test(file.replace(/\\/g,'/'))) return new PassThrough();
  if (cache[file]) return makeStream(cache[file])
  var uglify = require(file)
  var src = 'var sys = require("util");\nvar MOZ_SourceMap = require("source-map");\nvar UglifyJS = exports;\n' + uglify.FILES.map(function (path) ***REMOVED*** return fs.readFileSync(path, 'utf8') ***REMOVED***).join('\n')

  var ast = uglify.parse(src)
  ast.figure_out_scope()

  var variables = ast.variables
    .map(function (node, name) ***REMOVED***
      return name
    ***REMOVED***)

  src += '\n\n' + variables.map(function (v) ***REMOVED*** return 'exports.' + v + ' = ' + v + ';' ***REMOVED***).join('\n') + '\n\n'

  src += 'exports.AST_Node.warn_function = function (txt) ***REMOVED*** if (typeof console != "undefined" && typeof console.warn === "function") console.warn(txt) ***REMOVED***\n\n'

  src += 'exports.minify = ' + uglify.minify.toString() + ';\n\n'
  src += 'exports.describe_ast = ' + uglify.describe_ast.toString() + ';'

  // TODO: remove once https://github.com/substack/node-browserify/issues/631 is resolved
  src = src.replace(/"for"/g, '"fo" + "r"')

  cache[file] = src
  return makeStream(src);
***REMOVED***

function makeStream(src) ***REMOVED***
  var res = new Transform();
  res._transform = function (chunk, encoding, callback) ***REMOVED*** callback() ***REMOVED***
  res._flush = function (callback) ***REMOVED***
    res.push(src)
    callback()
  ***REMOVED***
  return res;
***REMOVED***
