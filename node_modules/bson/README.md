# BSON parser

BSON is short for Bin­ary JSON and is the bin­ary-en­coded seri­al­iz­a­tion of JSON-like doc­u­ments. You can learn more about it in [the specification](http://bsonspec.org).

This browser version of the BSON parser is compiled using [webpack](https://webpack.js.org/) and the current version is pre-compiled in the `browser_build` directory.

This is the default BSON parser, however, there is a C++ Node.js addon version as well that does not support the browser. It can be found at [mongod-js/bson-ext](https://github.com/mongodb-js/bson-ext).

## Usage

To build a new version perform the following operations:

```
npm install
npm run build
```

A simple example of how to use BSON in the browser:

```html
<script src="./browser_build/bson.js"></script>

<script>
  function start() ***REMOVED***
    // Get the Long type
    var Long = BSON.Long;
    // Create a bson parser instance
    var bson = new BSON();

    // Serialize document
    var doc = ***REMOVED*** long: Long.fromNumber(100) ***REMOVED***

    // Serialize a document
    var data = bson.serialize(doc)
    // De serialize it again
    var doc_2 = bson.deserialize(data)
  ***REMOVED***
</script>
```

A simple example of how to use BSON in `Node.js`:

```js
// Get BSON parser class
var BSON = require('bson')
// Get the Long type
var Long = BSON.Long;
// Create a bson parser instance
var bson = new BSON();

// Serialize document
var doc = ***REMOVED*** long: Long.fromNumber(100) ***REMOVED***

// Serialize a document
var data = bson.serialize(doc)
console.log('data:', data)

// Deserialize the resulting Buffer
var doc_2 = bson.deserialize(data)
console.log('doc_2:', doc_2)
```

## Installation

`npm install bson`

## API

### BSON types

For all BSON types documentation, please refer to the following sources:
  * [MongoDB BSON Type Reference](https://docs.mongodb.com/manual/reference/bson-types/)
  * [BSON Spec](https://bsonspec.org/)

### BSON serialization and deserialiation

**`new BSON()`** - Creates a new BSON serializer/deserializer you can use to serialize and deserialize BSON.

#### BSON.serialize

The BSON `serialize` method takes a JavaScript object and an optional options object and returns a Node.js Buffer.

  * `BSON.serialize(object, options)`
    * @param ***REMOVED***Object***REMOVED*** object the JavaScript object to serialize.
    * @param ***REMOVED***Boolean***REMOVED*** [options.checkKeys=false] the serializer will check if keys are valid.
    * @param ***REMOVED***Boolean***REMOVED*** [options.serializeFunctions=false] serialize the JavaScript functions.
    * @param ***REMOVED***Boolean***REMOVED*** [options.ignoreUndefined=true]
    * @return ***REMOVED***Buffer***REMOVED*** returns a Buffer instance.

#### BSON.serializeWithBufferAndIndex

The BSON `serializeWithBufferAndIndex` method takes an object, a target buffer instance and an optional options object and returns the end serialization index in the final buffer.

  * `BSON.serializeWithBufferAndIndex(object, buffer, options)`
    * @param ***REMOVED***Object***REMOVED*** object the JavaScript object to serialize.
    * @param ***REMOVED***Buffer***REMOVED*** buffer the Buffer you pre-allocated to store the serialized BSON object.
    * @param ***REMOVED***Boolean***REMOVED*** [options.checkKeys=false] the serializer will check if keys are valid.
    * @param ***REMOVED***Boolean***REMOVED*** [options.serializeFunctions=false] serialize the JavaScript functions.
    * @param ***REMOVED***Boolean***REMOVED*** [options.ignoreUndefined=true] ignore undefined fields.
    * @param ***REMOVED***Number***REMOVED*** [options.index=0] the index in the buffer where we wish to start serializing into.
    * @return ***REMOVED***Number***REMOVED*** returns the index pointing to the last written byte in the buffer.

#### BSON.calculateObjectSize

The BSON `calculateObjectSize` method takes a JavaScript object and an optional options object and returns the size of the BSON object.

  * `BSON.calculateObjectSize(object, options)`
    * @param ***REMOVED***Object***REMOVED*** object the JavaScript object to serialize.
    * @param ***REMOVED***Boolean***REMOVED*** [options.serializeFunctions=false] serialize the JavaScript functions.
    * @param ***REMOVED***Boolean***REMOVED*** [options.ignoreUndefined=true]
    * @return ***REMOVED***Buffer***REMOVED*** returns a Buffer instance.

#### BSON.deserialize

The BSON `deserialize` method takes a Node.js Buffer and an optional options object and returns a deserialized JavaScript object.

  * `BSON.deserialize(buffer, options)`
    * @param ***REMOVED***Object***REMOVED*** [options.evalFunctions=false] evaluate functions in the BSON document scoped to the object deserialized.
    * @param ***REMOVED***Object***REMOVED*** [options.cacheFunctions=false] cache evaluated functions for reuse.
    * @param ***REMOVED***Object***REMOVED*** [options.cacheFunctionsCrc32=false] use a crc32 code for caching, otherwise use the string of the function.
    * @param ***REMOVED***Object***REMOVED*** [options.promoteLongs=true] when deserializing a Long will fit it into a Number if it's smaller than 53 bits
    * @param ***REMOVED***Object***REMOVED*** [options.promoteBuffers=false] when deserializing a Binary will return it as a Node.js Buffer instance.
    * @param ***REMOVED***Object***REMOVED*** [options.promoteValues=false] when deserializing will promote BSON values to their Node.js closest equivalent types.
    * @param ***REMOVED***Object***REMOVED*** [options.fieldsAsRaw=null] allow to specify if there what fields we wish to return as unserialized raw buffer.
    * @param ***REMOVED***Object***REMOVED*** [options.bsonRegExp=false] return BSON regular expressions as BSONRegExp instances.
    * @return ***REMOVED***Object***REMOVED*** returns the deserialized Javascript Object.

#### BSON.deserializeStream

The BSON `deserializeStream` method takes a Node.js Buffer, `startIndex` and allow more control over deserialization of a Buffer containing concatenated BSON documents.

  * `BSON.deserializeStream(buffer, startIndex, numberOfDocuments, documents, docStartIndex, options)`
    * @param ***REMOVED***Buffer***REMOVED*** buffer the buffer containing the serialized set of BSON documents.
    * @param ***REMOVED***Number***REMOVED*** startIndex the start index in the data Buffer where the deserialization is to start.
    * @param ***REMOVED***Number***REMOVED*** numberOfDocuments number of documents to deserialize.
    * @param ***REMOVED***Array***REMOVED*** documents an array where to store the deserialized documents.
    * @param ***REMOVED***Number***REMOVED*** docStartIndex the index in the documents array from where to start inserting documents.
    * @param ***REMOVED***Object***REMOVED*** [options.evalFunctions=false] evaluate functions in the BSON document scoped to the object deserialized.
    * @param ***REMOVED***Object***REMOVED*** [options.cacheFunctions=false] cache evaluated functions for reuse.
    * @param ***REMOVED***Object***REMOVED*** [options.cacheFunctionsCrc32=false] use a crc32 code for caching, otherwise use the string of the function.
    * @param ***REMOVED***Object***REMOVED*** [options.promoteLongs=true] when deserializing a Long will fit it into a Number if it's smaller than 53 bits
    * @param ***REMOVED***Object***REMOVED*** [options.promoteBuffers=false] when deserializing a Binary will return it as a Node.js Buffer instance.
    * @param ***REMOVED***Object***REMOVED*** [options.promoteValues=false] when deserializing will promote BSON values to their Node.js closest equivalent types.
    * @param ***REMOVED***Object***REMOVED*** [options.fieldsAsRaw=null] allow to specify if there what fields we wish to return as unserialized raw buffer.
    * @param ***REMOVED***Object***REMOVED*** [options.bsonRegExp=false] return BSON regular expressions as BSONRegExp instances.
    * @return ***REMOVED***Number***REMOVED*** returns the next index in the buffer after deserialization **x** numbers of documents.

## FAQ

#### Why does `undefined` get converted to `null`?

The `undefined` BSON type has been [deprecated for many years](http://bsonspec.org/spec.html), so this library has dropped support for it. Use the `ignoreUndefined` option (for example, from the [driver](http://mongodb.github.io/node-mongodb-native/2.2/api/MongoClient.html#connect) ) to instead remove `undefined` keys.

#### How do I add custom serialization logic?

This library looks for `toBSON()` functions on every path, and calls the `toBSON()` function to get the value to serialize.

```javascript
var bson = new BSON();

class CustomSerialize ***REMOVED***
  toBSON() ***REMOVED***
    return 42;
  ***REMOVED***
***REMOVED***

const obj = ***REMOVED*** answer: new CustomSerialize() ***REMOVED***;
// "***REMOVED*** answer: 42 ***REMOVED***"
console.log(bson.deserialize(bson.serialize(obj)));
```
