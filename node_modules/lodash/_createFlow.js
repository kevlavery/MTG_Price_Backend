var LodashWrapper = require('./_LodashWrapper'),
    flatRest = require('./_flatRest'),
    getData = require('./_getData'),
    getFuncName = require('./_getFuncName'),
    isArray = require('./isArray'),
    isLaziable = require('./_isLaziable');

/** Error message constants. */
var FUNC_ERROR_TEXT = 'Expected a function';

/** Used to compose bitmasks for function metadata. */
var WRAP_CURRY_FLAG = 8,
    WRAP_PARTIAL_FLAG = 32,
    WRAP_ARY_FLAG = 128,
    WRAP_REARG_FLAG = 256;

/**
 * Creates a `_.flow` or `_.flowRight` function.
 *
 * @private
 * @param ***REMOVED***boolean***REMOVED*** [fromRight] Specify iterating from right to left.
 * @returns ***REMOVED***Function***REMOVED*** Returns the new flow function.
 */
function createFlow(fromRight) ***REMOVED***
  return flatRest(function(funcs) ***REMOVED***
    var length = funcs.length,
        index = length,
        prereq = LodashWrapper.prototype.thru;

    if (fromRight) ***REMOVED***
      funcs.reverse();
    ***REMOVED***
    while (index--) ***REMOVED***
      var func = funcs[index];
      if (typeof func != 'function') ***REMOVED***
        throw new TypeError(FUNC_ERROR_TEXT);
      ***REMOVED***
      if (prereq && !wrapper && getFuncName(func) == 'wrapper') ***REMOVED***
        var wrapper = new LodashWrapper([], true);
      ***REMOVED***
    ***REMOVED***
    index = wrapper ? index : length;
    while (++index < length) ***REMOVED***
      func = funcs[index];

      var funcName = getFuncName(func),
          data = funcName == 'wrapper' ? getData(func) : undefined;

      if (data && isLaziable(data[0]) &&
            data[1] == (WRAP_ARY_FLAG | WRAP_CURRY_FLAG | WRAP_PARTIAL_FLAG | WRAP_REARG_FLAG) &&
            !data[4].length && data[9] == 1
          ) ***REMOVED***
        wrapper = wrapper[getFuncName(data[0])].apply(wrapper, data[3]);
      ***REMOVED*** else ***REMOVED***
        wrapper = (func.length == 1 && isLaziable(func))
          ? wrapper[funcName]()
          : wrapper.thru(func);
      ***REMOVED***
    ***REMOVED***
    return function() ***REMOVED***
      var args = arguments,
          value = args[0];

      if (wrapper && args.length == 1 && isArray(value)) ***REMOVED***
        return wrapper.plant(value).value();
      ***REMOVED***
      var index = 0,
          result = length ? funcs[index].apply(this, args) : value;

      while (++index < length) ***REMOVED***
        result = funcs[index].call(this, result);
      ***REMOVED***
      return result;
    ***REMOVED***;
  ***REMOVED***);
***REMOVED***

module.exports = createFlow;
