var baseToString = require('./_baseToString'),
    castSlice = require('./_castSlice'),
    hasUnicode = require('./_hasUnicode'),
    isObject = require('./isObject'),
    isRegExp = require('./isRegExp'),
    stringSize = require('./_stringSize'),
    stringToArray = require('./_stringToArray'),
    toInteger = require('./toInteger'),
    toString = require('./toString');

/** Used as default options for `_.truncate`. */
var DEFAULT_TRUNC_LENGTH = 30,
    DEFAULT_TRUNC_OMISSION = '...';

/** Used to match `RegExp` flags from their coerced string values. */
var reFlags = /\w*$/;

/**
 * Truncates `string` if it's longer than the given maximum string length.
 * The last characters of the truncated string are replaced with the omission
 * string which defaults to "...".
 *
 * @static
 * @memberOf _
 * @since 4.0.0
 * @category String
 * @param ***REMOVED***string***REMOVED*** [string=''] The string to truncate.
 * @param ***REMOVED***Object***REMOVED*** [options=***REMOVED******REMOVED***] The options object.
 * @param ***REMOVED***number***REMOVED*** [options.length=30] The maximum string length.
 * @param ***REMOVED***string***REMOVED*** [options.omission='...'] The string to indicate text is omitted.
 * @param ***REMOVED***RegExp|string***REMOVED*** [options.separator] The separator pattern to truncate to.
 * @returns ***REMOVED***string***REMOVED*** Returns the truncated string.
 * @example
 *
 * _.truncate('hi-diddly-ho there, neighborino');
 * // => 'hi-diddly-ho there, neighbo...'
 *
 * _.truncate('hi-diddly-ho there, neighborino', ***REMOVED***
 *   'length': 24,
 *   'separator': ' '
 * ***REMOVED***);
 * // => 'hi-diddly-ho there,...'
 *
 * _.truncate('hi-diddly-ho there, neighborino', ***REMOVED***
 *   'length': 24,
 *   'separator': /,? +/
 * ***REMOVED***);
 * // => 'hi-diddly-ho there...'
 *
 * _.truncate('hi-diddly-ho there, neighborino', ***REMOVED***
 *   'omission': ' [...]'
 * ***REMOVED***);
 * // => 'hi-diddly-ho there, neig [...]'
 */
function truncate(string, options) ***REMOVED***
  var length = DEFAULT_TRUNC_LENGTH,
      omission = DEFAULT_TRUNC_OMISSION;

  if (isObject(options)) ***REMOVED***
    var separator = 'separator' in options ? options.separator : separator;
    length = 'length' in options ? toInteger(options.length) : length;
    omission = 'omission' in options ? baseToString(options.omission) : omission;
  ***REMOVED***
  string = toString(string);

  var strLength = string.length;
  if (hasUnicode(string)) ***REMOVED***
    var strSymbols = stringToArray(string);
    strLength = strSymbols.length;
  ***REMOVED***
  if (length >= strLength) ***REMOVED***
    return string;
  ***REMOVED***
  var end = length - stringSize(omission);
  if (end < 1) ***REMOVED***
    return omission;
  ***REMOVED***
  var result = strSymbols
    ? castSlice(strSymbols, 0, end).join('')
    : string.slice(0, end);

  if (separator === undefined) ***REMOVED***
    return result + omission;
  ***REMOVED***
  if (strSymbols) ***REMOVED***
    end += (result.length - end);
  ***REMOVED***
  if (isRegExp(separator)) ***REMOVED***
    if (string.slice(end).search(separator)) ***REMOVED***
      var match,
          substring = result;

      if (!separator.global) ***REMOVED***
        separator = RegExp(separator.source, toString(reFlags.exec(separator)) + 'g');
      ***REMOVED***
      separator.lastIndex = 0;
      while ((match = separator.exec(substring))) ***REMOVED***
        var newEnd = match.index;
      ***REMOVED***
      result = result.slice(0, newEnd === undefined ? end : newEnd);
    ***REMOVED***
  ***REMOVED*** else if (string.indexOf(baseToString(separator), end) != end) ***REMOVED***
    var index = result.lastIndexOf(separator);
    if (index > -1) ***REMOVED***
      result = result.slice(0, index);
    ***REMOVED***
  ***REMOVED***
  return result + omission;
***REMOVED***

module.exports = truncate;
