var assignInWith = require('./assignInWith'),
    attempt = require('./attempt'),
    baseValues = require('./_baseValues'),
    customDefaultsAssignIn = require('./_customDefaultsAssignIn'),
    escapeStringChar = require('./_escapeStringChar'),
    isError = require('./isError'),
    isIterateeCall = require('./_isIterateeCall'),
    keys = require('./keys'),
    reInterpolate = require('./_reInterpolate'),
    templateSettings = require('./templateSettings'),
    toString = require('./toString');

/** Used to match empty string literals in compiled template source. */
var reEmptyStringLeading = /\b__p \+= '';/g,
    reEmptyStringMiddle = /\b(__p \+=) '' \+/g,
    reEmptyStringTrailing = /(__e\(.*?\)|\b__t\)) \+\n'';/g;

/**
 * Used to match
 * [ES template delimiters](http://ecma-international.org/ecma-262/7.0/#sec-template-literal-lexical-components).
 */
var reEsTemplate = /\$\***REMOVED***([^\\***REMOVED***]*(?:\\.[^\\***REMOVED***]*)*)\***REMOVED***/g;

/** Used to ensure capturing order of template delimiters. */
var reNoMatch = /($^)/;

/** Used to match unescaped characters in compiled string literals. */
var reUnescapedString = /['\n\r\u2028\u2029\\]/g;

/**
 * Creates a compiled template function that can interpolate data properties
 * in "interpolate" delimiters, HTML-escape interpolated data properties in
 * "escape" delimiters, and execute JavaScript in "evaluate" delimiters. Data
 * properties may be accessed as free variables in the template. If a setting
 * object is given, it takes precedence over `_.templateSettings` values.
 *
 * **Note:** In the development build `_.template` utilizes
 * [sourceURLs](http://www.html5rocks.com/en/tutorials/developertools/sourcemaps/#toc-sourceurl)
 * for easier debugging.
 *
 * For more information on precompiling templates see
 * [lodash's custom builds documentation](https://lodash.com/custom-builds).
 *
 * For more information on Chrome extension sandboxes see
 * [Chrome's extensions documentation](https://developer.chrome.com/extensions/sandboxingEval).
 *
 * @static
 * @since 0.1.0
 * @memberOf _
 * @category String
 * @param ***REMOVED***string***REMOVED*** [string=''] The template string.
 * @param ***REMOVED***Object***REMOVED*** [options=***REMOVED******REMOVED***] The options object.
 * @param ***REMOVED***RegExp***REMOVED*** [options.escape=_.templateSettings.escape]
 *  The HTML "escape" delimiter.
 * @param ***REMOVED***RegExp***REMOVED*** [options.evaluate=_.templateSettings.evaluate]
 *  The "evaluate" delimiter.
 * @param ***REMOVED***Object***REMOVED*** [options.imports=_.templateSettings.imports]
 *  An object to import into the template as free variables.
 * @param ***REMOVED***RegExp***REMOVED*** [options.interpolate=_.templateSettings.interpolate]
 *  The "interpolate" delimiter.
 * @param ***REMOVED***string***REMOVED*** [options.sourceURL='templateSources[n]']
 *  The sourceURL of the compiled template.
 * @param ***REMOVED***string***REMOVED*** [options.variable='obj']
 *  The data object variable name.
 * @param- ***REMOVED***Object***REMOVED*** [guard] Enables use as an iteratee for methods like `_.map`.
 * @returns ***REMOVED***Function***REMOVED*** Returns the compiled template function.
 * @example
 *
 * // Use the "interpolate" delimiter to create a compiled template.
 * var compiled = _.template('hello <%= user %>!');
 * compiled(***REMOVED*** 'user': 'fred' ***REMOVED***);
 * // => 'hello fred!'
 *
 * // Use the HTML "escape" delimiter to escape data property values.
 * var compiled = _.template('<b><%- value %></b>');
 * compiled(***REMOVED*** 'value': '<script>' ***REMOVED***);
 * // => '<b>&lt;script&gt;</b>'
 *
 * // Use the "evaluate" delimiter to execute JavaScript and generate HTML.
 * var compiled = _.template('<% _.forEach(users, function(user) ***REMOVED*** %><li><%- user %></li><% ***REMOVED***); %>');
 * compiled(***REMOVED*** 'users': ['fred', 'barney'] ***REMOVED***);
 * // => '<li>fred</li><li>barney</li>'
 *
 * // Use the internal `print` function in "evaluate" delimiters.
 * var compiled = _.template('<% print("hello " + user); %>!');
 * compiled(***REMOVED*** 'user': 'barney' ***REMOVED***);
 * // => 'hello barney!'
 *
 * // Use the ES template literal delimiter as an "interpolate" delimiter.
 * // Disable support by replacing the "interpolate" delimiter.
 * var compiled = _.template('hello $***REMOVED*** user ***REMOVED***!');
 * compiled(***REMOVED*** 'user': 'pebbles' ***REMOVED***);
 * // => 'hello pebbles!'
 *
 * // Use backslashes to treat delimiters as plain text.
 * var compiled = _.template('<%= "\\<%- value %\\>" %>');
 * compiled(***REMOVED*** 'value': 'ignored' ***REMOVED***);
 * // => '<%- value %>'
 *
 * // Use the `imports` option to import `jQuery` as `jq`.
 * var text = '<% jq.each(users, function(user) ***REMOVED*** %><li><%- user %></li><% ***REMOVED***); %>';
 * var compiled = _.template(text, ***REMOVED*** 'imports': ***REMOVED*** 'jq': jQuery ***REMOVED*** ***REMOVED***);
 * compiled(***REMOVED*** 'users': ['fred', 'barney'] ***REMOVED***);
 * // => '<li>fred</li><li>barney</li>'
 *
 * // Use the `sourceURL` option to specify a custom sourceURL for the template.
 * var compiled = _.template('hello <%= user %>!', ***REMOVED*** 'sourceURL': '/basic/greeting.jst' ***REMOVED***);
 * compiled(data);
 * // => Find the source of "greeting.jst" under the Sources tab or Resources panel of the web inspector.
 *
 * // Use the `variable` option to ensure a with-statement isn't used in the compiled template.
 * var compiled = _.template('hi <%= data.user %>!', ***REMOVED*** 'variable': 'data' ***REMOVED***);
 * compiled.source;
 * // => function(data) ***REMOVED***
 * //   var __t, __p = '';
 * //   __p += 'hi ' + ((__t = ( data.user )) == null ? '' : __t) + '!';
 * //   return __p;
 * // ***REMOVED***
 *
 * // Use custom template delimiters.
 * _.templateSettings.interpolate = /***REMOVED******REMOVED***([\s\S]+?)***REMOVED******REMOVED***/g;
 * var compiled = _.template('hello ***REMOVED******REMOVED*** user ***REMOVED******REMOVED***!');
 * compiled(***REMOVED*** 'user': 'mustache' ***REMOVED***);
 * // => 'hello mustache!'
 *
 * // Use the `source` property to inline compiled templates for meaningful
 * // line numbers in error messages and stack traces.
 * fs.writeFileSync(path.join(process.cwd(), 'jst.js'), '\
 *   var JST = ***REMOVED***\
 *     "main": ' + _.template(mainText).source + '\
 *   ***REMOVED***;\
 * ');
 */
function template(string, options, guard) ***REMOVED***
  // Based on John Resig's `tmpl` implementation
  // (http://ejohn.org/blog/javascript-micro-templating/)
  // and Laura Doktorova's doT.js (https://github.com/olado/doT).
  var settings = templateSettings.imports._.templateSettings || templateSettings;

  if (guard && isIterateeCall(string, options, guard)) ***REMOVED***
    options = undefined;
  ***REMOVED***
  string = toString(string);
  options = assignInWith(***REMOVED******REMOVED***, options, settings, customDefaultsAssignIn);

  var imports = assignInWith(***REMOVED******REMOVED***, options.imports, settings.imports, customDefaultsAssignIn),
      importsKeys = keys(imports),
      importsValues = baseValues(imports, importsKeys);

  var isEscaping,
      isEvaluating,
      index = 0,
      interpolate = options.interpolate || reNoMatch,
      source = "__p += '";

  // Compile the regexp to match each delimiter.
  var reDelimiters = RegExp(
    (options.escape || reNoMatch).source + '|' +
    interpolate.source + '|' +
    (interpolate === reInterpolate ? reEsTemplate : reNoMatch).source + '|' +
    (options.evaluate || reNoMatch).source + '|$'
  , 'g');

  // Use a sourceURL for easier debugging.
  var sourceURL = 'sourceURL' in options ? '//# sourceURL=' + options.sourceURL + '\n' : '';

  string.replace(reDelimiters, function(match, escapeValue, interpolateValue, esTemplateValue, evaluateValue, offset) ***REMOVED***
    interpolateValue || (interpolateValue = esTemplateValue);

    // Escape characters that can't be included in string literals.
    source += string.slice(index, offset).replace(reUnescapedString, escapeStringChar);

    // Replace delimiters with snippets.
    if (escapeValue) ***REMOVED***
      isEscaping = true;
      source += "' +\n__e(" + escapeValue + ") +\n'";
    ***REMOVED***
    if (evaluateValue) ***REMOVED***
      isEvaluating = true;
      source += "';\n" + evaluateValue + ";\n__p += '";
    ***REMOVED***
    if (interpolateValue) ***REMOVED***
      source += "' +\n((__t = (" + interpolateValue + ")) == null ? '' : __t) +\n'";
    ***REMOVED***
    index = offset + match.length;

    // The JS engine embedded in Adobe products needs `match` returned in
    // order to produce the correct `offset` value.
    return match;
  ***REMOVED***);

  source += "';\n";

  // If `variable` is not specified wrap a with-statement around the generated
  // code to add the data object to the top of the scope chain.
  var variable = options.variable;
  if (!variable) ***REMOVED***
    source = 'with (obj) ***REMOVED***\n' + source + '\n***REMOVED***\n';
  ***REMOVED***
  // Cleanup code by stripping empty strings.
  source = (isEvaluating ? source.replace(reEmptyStringLeading, '') : source)
    .replace(reEmptyStringMiddle, '$1')
    .replace(reEmptyStringTrailing, '$1;');

  // Frame code as the function body.
  source = 'function(' + (variable || 'obj') + ') ***REMOVED***\n' +
    (variable
      ? ''
      : 'obj || (obj = ***REMOVED******REMOVED***);\n'
    ) +
    "var __t, __p = ''" +
    (isEscaping
       ? ', __e = _.escape'
       : ''
    ) +
    (isEvaluating
      ? ', __j = Array.prototype.join;\n' +
        "function print() ***REMOVED*** __p += __j.call(arguments, '') ***REMOVED***\n"
      : ';\n'
    ) +
    source +
    'return __p\n***REMOVED***';

  var result = attempt(function() ***REMOVED***
    return Function(importsKeys, sourceURL + 'return ' + source)
      .apply(undefined, importsValues);
  ***REMOVED***);

  // Provide the compiled function's source by its `toString` method or
  // the `source` property as a convenience for inlining compiled templates.
  result.source = source;
  if (isError(result)) ***REMOVED***
    throw result;
  ***REMOVED***
  return result;
***REMOVED***

module.exports = template;
