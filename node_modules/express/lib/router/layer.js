/*!
 * express
 * Copyright(c) 2009-2013 TJ Holowaychuk
 * Copyright(c) 2013 Roman Shtylman
 * Copyright(c) 2014-2015 Douglas Christopher Wilson
 * MIT Licensed
 */

'use strict';

/**
 * Module dependencies.
 * @private
 */

var pathRegexp = require('path-to-regexp');
var debug = require('debug')('express:router:layer');

/**
 * Module variables.
 * @private
 */

var hasOwnProperty = Object.prototype.hasOwnProperty;

/**
 * Module exports.
 * @public
 */

module.exports = Layer;

function Layer(path, options, fn) ***REMOVED***
  if (!(this instanceof Layer)) ***REMOVED***
    return new Layer(path, options, fn);
  ***REMOVED***

  debug('new %o', path)
  var opts = options || ***REMOVED******REMOVED***;

  this.handle = fn;
  this.name = fn.name || '<anonymous>';
  this.params = undefined;
  this.path = undefined;
  this.regexp = pathRegexp(path, this.keys = [], opts);

  // set fast path flags
  this.regexp.fast_star = path === '*'
  this.regexp.fast_slash = path === '/' && opts.end === false
***REMOVED***

/**
 * Handle the error for the layer.
 *
 * @param ***REMOVED***Error***REMOVED*** error
 * @param ***REMOVED***Request***REMOVED*** req
 * @param ***REMOVED***Response***REMOVED*** res
 * @param ***REMOVED***function***REMOVED*** next
 * @api private
 */

Layer.prototype.handle_error = function handle_error(error, req, res, next) ***REMOVED***
  var fn = this.handle;

  if (fn.length !== 4) ***REMOVED***
    // not a standard error handler
    return next(error);
  ***REMOVED***

  try ***REMOVED***
    fn(error, req, res, next);
  ***REMOVED*** catch (err) ***REMOVED***
    next(err);
  ***REMOVED***
***REMOVED***;

/**
 * Handle the request for the layer.
 *
 * @param ***REMOVED***Request***REMOVED*** req
 * @param ***REMOVED***Response***REMOVED*** res
 * @param ***REMOVED***function***REMOVED*** next
 * @api private
 */

Layer.prototype.handle_request = function handle(req, res, next) ***REMOVED***
  var fn = this.handle;

  if (fn.length > 3) ***REMOVED***
    // not a standard request handler
    return next();
  ***REMOVED***

  try ***REMOVED***
    fn(req, res, next);
  ***REMOVED*** catch (err) ***REMOVED***
    next(err);
  ***REMOVED***
***REMOVED***;

/**
 * Check if this route matches `path`, if so
 * populate `.params`.
 *
 * @param ***REMOVED***String***REMOVED*** path
 * @return ***REMOVED***Boolean***REMOVED***
 * @api private
 */

Layer.prototype.match = function match(path) ***REMOVED***
  var match

  if (path != null) ***REMOVED***
    // fast path non-ending match for / (any path matches)
    if (this.regexp.fast_slash) ***REMOVED***
      this.params = ***REMOVED******REMOVED***
      this.path = ''
      return true
    ***REMOVED***

    // fast path for * (everything matched in a param)
    if (this.regexp.fast_star) ***REMOVED***
      this.params = ***REMOVED***'0': decode_param(path)***REMOVED***
      this.path = path
      return true
    ***REMOVED***

    // match the path
    match = this.regexp.exec(path)
  ***REMOVED***

  if (!match) ***REMOVED***
    this.params = undefined;
    this.path = undefined;
    return false;
  ***REMOVED***

  // store values
  this.params = ***REMOVED******REMOVED***;
  this.path = match[0]

  var keys = this.keys;
  var params = this.params;

  for (var i = 1; i < match.length; i++) ***REMOVED***
    var key = keys[i - 1];
    var prop = key.name;
    var val = decode_param(match[i])

    if (val !== undefined || !(hasOwnProperty.call(params, prop))) ***REMOVED***
      params[prop] = val;
    ***REMOVED***
  ***REMOVED***

  return true;
***REMOVED***;

/**
 * Decode param value.
 *
 * @param ***REMOVED***string***REMOVED*** val
 * @return ***REMOVED***string***REMOVED***
 * @private
 */

function decode_param(val) ***REMOVED***
  if (typeof val !== 'string' || val.length === 0) ***REMOVED***
    return val;
  ***REMOVED***

  try ***REMOVED***
    return decodeURIComponent(val);
  ***REMOVED*** catch (err) ***REMOVED***
    if (err instanceof URIError) ***REMOVED***
      err.message = 'Failed to decode param \'' + val + '\'';
      err.status = err.statusCode = 400;
    ***REMOVED***

    throw err;
  ***REMOVED***
***REMOVED***
