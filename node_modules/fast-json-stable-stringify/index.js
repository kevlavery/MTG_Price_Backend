'use strict';

module.exports = function (data, opts) ***REMOVED***
    if (!opts) opts = ***REMOVED******REMOVED***;
    if (typeof opts === 'function') opts = ***REMOVED*** cmp: opts ***REMOVED***;
    var cycles = (typeof opts.cycles === 'boolean') ? opts.cycles : false;

    var cmp = opts.cmp && (function (f) ***REMOVED***
        return function (node) ***REMOVED***
            return function (a, b) ***REMOVED***
                var aobj = ***REMOVED*** key: a, value: node[a] ***REMOVED***;
                var bobj = ***REMOVED*** key: b, value: node[b] ***REMOVED***;
                return f(aobj, bobj);
            ***REMOVED***;
        ***REMOVED***;
    ***REMOVED***)(opts.cmp);

    var seen = [];
    return (function stringify (node) ***REMOVED***
        if (node && node.toJSON && typeof node.toJSON === 'function') ***REMOVED***
            node = node.toJSON();
        ***REMOVED***

        if (node === undefined) return;
        if (typeof node == 'number') return isFinite(node) ? '' + node : 'null';
        if (typeof node !== 'object') return JSON.stringify(node);

        var i, out;
        if (Array.isArray(node)) ***REMOVED***
            out = '[';
            for (i = 0; i < node.length; i++) ***REMOVED***
                if (i) out += ',';
                out += stringify(node[i]) || 'null';
            ***REMOVED***
            return out + ']';
        ***REMOVED***

        if (node === null) return 'null';

        if (seen.indexOf(node) !== -1) ***REMOVED***
            if (cycles) return JSON.stringify('__cycle__');
            throw new TypeError('Converting circular structure to JSON');
        ***REMOVED***

        var seenIndex = seen.push(node) - 1;
        var keys = Object.keys(node).sort(cmp && cmp(node));
        out = '';
        for (i = 0; i < keys.length; i++) ***REMOVED***
            var key = keys[i];
            var value = stringify(node[key]);

            if (!value) continue;
            if (out) out += ',';
            out += JSON.stringify(key) + ':' + value;
        ***REMOVED***
        seen.splice(seenIndex, 1);
        return '***REMOVED***' + out + '***REMOVED***';
    ***REMOVED***)(data);
***REMOVED***;
