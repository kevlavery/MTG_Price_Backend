/* eslint-disable node/no-deprecated-api */

'use strict'

var test = require('tape')

var buffer = require('buffer')

var index = require('./')
var safer = require('./safer')
var dangerous = require('./dangerous')

/* Inheritance tests */

test('Default is Safer', function (t) ***REMOVED***
  t.equal(index, safer)
  t.notEqual(safer, dangerous)
  t.notEqual(index, dangerous)
  t.end()
***REMOVED***)

test('Is not a function', function (t) ***REMOVED***
  [index, safer, dangerous].forEach(function (impl) ***REMOVED***
    t.equal(typeof impl, 'object')
    t.equal(typeof impl.Buffer, 'object')
  ***REMOVED***);
  [buffer].forEach(function (impl) ***REMOVED***
    t.equal(typeof impl, 'object')
    t.equal(typeof impl.Buffer, 'function')
  ***REMOVED***)
  t.end()
***REMOVED***)

test('Constructor throws', function (t) ***REMOVED***
  [index, safer, dangerous].forEach(function (impl) ***REMOVED***
    t.throws(function () ***REMOVED*** impl.Buffer() ***REMOVED***)
    t.throws(function () ***REMOVED*** impl.Buffer(0) ***REMOVED***)
    t.throws(function () ***REMOVED*** impl.Buffer('a') ***REMOVED***)
    t.throws(function () ***REMOVED*** impl.Buffer('a', 'utf-8') ***REMOVED***)
    t.throws(function () ***REMOVED*** return new impl.Buffer() ***REMOVED***)
    t.throws(function () ***REMOVED*** return new impl.Buffer(0) ***REMOVED***)
    t.throws(function () ***REMOVED*** return new impl.Buffer('a') ***REMOVED***)
    t.throws(function () ***REMOVED*** return new impl.Buffer('a', 'utf-8') ***REMOVED***)
  ***REMOVED***)
  t.end()
***REMOVED***)

test('Safe methods exist', function (t) ***REMOVED***
  [index, safer, dangerous].forEach(function (impl) ***REMOVED***
    t.equal(typeof impl.Buffer.alloc, 'function', 'alloc')
    t.equal(typeof impl.Buffer.from, 'function', 'from')
  ***REMOVED***)
  t.end()
***REMOVED***)

test('Unsafe methods exist only in Dangerous', function (t) ***REMOVED***
  [index, safer].forEach(function (impl) ***REMOVED***
    t.equal(typeof impl.Buffer.allocUnsafe, 'undefined')
    t.equal(typeof impl.Buffer.allocUnsafeSlow, 'undefined')
  ***REMOVED***);
  [dangerous].forEach(function (impl) ***REMOVED***
    t.equal(typeof impl.Buffer.allocUnsafe, 'function')
    t.equal(typeof impl.Buffer.allocUnsafeSlow, 'function')
  ***REMOVED***)
  t.end()
***REMOVED***)

test('Generic methods/properties are defined and equal', function (t) ***REMOVED***
  ['poolSize', 'isBuffer', 'concat', 'byteLength'].forEach(function (method) ***REMOVED***
    [index, safer, dangerous].forEach(function (impl) ***REMOVED***
      t.equal(impl.Buffer[method], buffer.Buffer[method], method)
      t.notEqual(typeof impl.Buffer[method], 'undefined', method)
    ***REMOVED***)
  ***REMOVED***)
  t.end()
***REMOVED***)

test('Built-in buffer static methods/properties are inherited', function (t) ***REMOVED***
  Object.keys(buffer).forEach(function (method) ***REMOVED***
    if (method === 'SlowBuffer' || method === 'Buffer') return;
    [index, safer, dangerous].forEach(function (impl) ***REMOVED***
      t.equal(impl[method], buffer[method], method)
      t.notEqual(typeof impl[method], 'undefined', method)
    ***REMOVED***)
  ***REMOVED***)
  t.end()
***REMOVED***)

test('Built-in Buffer static methods/properties are inherited', function (t) ***REMOVED***
  Object.keys(buffer.Buffer).forEach(function (method) ***REMOVED***
    if (method === 'allocUnsafe' || method === 'allocUnsafeSlow') return;
    [index, safer, dangerous].forEach(function (impl) ***REMOVED***
      t.equal(impl.Buffer[method], buffer.Buffer[method], method)
      t.notEqual(typeof impl.Buffer[method], 'undefined', method)
    ***REMOVED***)
  ***REMOVED***)
  t.end()
***REMOVED***)

test('.prototype property of Buffer is inherited', function (t) ***REMOVED***
  [index, safer, dangerous].forEach(function (impl) ***REMOVED***
    t.equal(impl.Buffer.prototype, buffer.Buffer.prototype, 'prototype')
    t.notEqual(typeof impl.Buffer.prototype, 'undefined', 'prototype')
  ***REMOVED***)
  t.end()
***REMOVED***)

test('All Safer methods are present in Dangerous', function (t) ***REMOVED***
  Object.keys(safer).forEach(function (method) ***REMOVED***
    if (method === 'Buffer') return;
    [index, safer, dangerous].forEach(function (impl) ***REMOVED***
      t.equal(impl[method], safer[method], method)
      if (method !== 'kStringMaxLength') ***REMOVED***
        t.notEqual(typeof impl[method], 'undefined', method)
      ***REMOVED***
    ***REMOVED***)
  ***REMOVED***)
  Object.keys(safer.Buffer).forEach(function (method) ***REMOVED***
    [index, safer, dangerous].forEach(function (impl) ***REMOVED***
      t.equal(impl.Buffer[method], safer.Buffer[method], method)
      t.notEqual(typeof impl.Buffer[method], 'undefined', method)
    ***REMOVED***)
  ***REMOVED***)
  t.end()
***REMOVED***)

test('Safe methods from Dangerous methods are present in Safer', function (t) ***REMOVED***
  Object.keys(dangerous).forEach(function (method) ***REMOVED***
    if (method === 'Buffer') return;
    [index, safer, dangerous].forEach(function (impl) ***REMOVED***
      t.equal(impl[method], dangerous[method], method)
      if (method !== 'kStringMaxLength') ***REMOVED***
        t.notEqual(typeof impl[method], 'undefined', method)
      ***REMOVED***
    ***REMOVED***)
  ***REMOVED***)
  Object.keys(dangerous.Buffer).forEach(function (method) ***REMOVED***
    if (method === 'allocUnsafe' || method === 'allocUnsafeSlow') return;
    [index, safer, dangerous].forEach(function (impl) ***REMOVED***
      t.equal(impl.Buffer[method], dangerous.Buffer[method], method)
      t.notEqual(typeof impl.Buffer[method], 'undefined', method)
    ***REMOVED***)
  ***REMOVED***)
  t.end()
***REMOVED***)

/* Behaviour tests */

test('Methods return Buffers', function (t) ***REMOVED***
  [index, safer, dangerous].forEach(function (impl) ***REMOVED***
    t.ok(buffer.Buffer.isBuffer(impl.Buffer.alloc(0)))
    t.ok(buffer.Buffer.isBuffer(impl.Buffer.alloc(0, 10)))
    t.ok(buffer.Buffer.isBuffer(impl.Buffer.alloc(0, 'a')))
    t.ok(buffer.Buffer.isBuffer(impl.Buffer.alloc(10)))
    t.ok(buffer.Buffer.isBuffer(impl.Buffer.alloc(10, 'x')))
    t.ok(buffer.Buffer.isBuffer(impl.Buffer.alloc(9, 'ab')))
    t.ok(buffer.Buffer.isBuffer(impl.Buffer.from('')))
    t.ok(buffer.Buffer.isBuffer(impl.Buffer.from('string')))
    t.ok(buffer.Buffer.isBuffer(impl.Buffer.from('string', 'utf-8')))
    t.ok(buffer.Buffer.isBuffer(impl.Buffer.from('b25ldHdvdGhyZWU=', 'base64')))
    t.ok(buffer.Buffer.isBuffer(impl.Buffer.from([0, 42, 3])))
    t.ok(buffer.Buffer.isBuffer(impl.Buffer.from(new Uint8Array([0, 42, 3]))))
    t.ok(buffer.Buffer.isBuffer(impl.Buffer.from([])))
  ***REMOVED***);
  ['allocUnsafe', 'allocUnsafeSlow'].forEach(function (method) ***REMOVED***
    t.ok(buffer.Buffer.isBuffer(dangerous.Buffer[method](0)))
    t.ok(buffer.Buffer.isBuffer(dangerous.Buffer[method](10)))
  ***REMOVED***)
  t.end()
***REMOVED***)

test('Constructor is buffer.Buffer', function (t) ***REMOVED***
  [index, safer, dangerous].forEach(function (impl) ***REMOVED***
    t.equal(impl.Buffer.alloc(0).constructor, buffer.Buffer)
    t.equal(impl.Buffer.alloc(0, 10).constructor, buffer.Buffer)
    t.equal(impl.Buffer.alloc(0, 'a').constructor, buffer.Buffer)
    t.equal(impl.Buffer.alloc(10).constructor, buffer.Buffer)
    t.equal(impl.Buffer.alloc(10, 'x').constructor, buffer.Buffer)
    t.equal(impl.Buffer.alloc(9, 'ab').constructor, buffer.Buffer)
    t.equal(impl.Buffer.from('').constructor, buffer.Buffer)
    t.equal(impl.Buffer.from('string').constructor, buffer.Buffer)
    t.equal(impl.Buffer.from('string', 'utf-8').constructor, buffer.Buffer)
    t.equal(impl.Buffer.from('b25ldHdvdGhyZWU=', 'base64').constructor, buffer.Buffer)
    t.equal(impl.Buffer.from([0, 42, 3]).constructor, buffer.Buffer)
    t.equal(impl.Buffer.from(new Uint8Array([0, 42, 3])).constructor, buffer.Buffer)
    t.equal(impl.Buffer.from([]).constructor, buffer.Buffer)
  ***REMOVED***);
  [0, 10, 100].forEach(function (arg) ***REMOVED***
    t.equal(dangerous.Buffer.allocUnsafe(arg).constructor, buffer.Buffer)
    t.equal(dangerous.Buffer.allocUnsafeSlow(arg).constructor, buffer.SlowBuffer(0).constructor)
  ***REMOVED***)
  t.end()
***REMOVED***)

test('Invalid calls throw', function (t) ***REMOVED***
  [index, safer, dangerous].forEach(function (impl) ***REMOVED***
    t.throws(function () ***REMOVED*** impl.Buffer.from(0) ***REMOVED***)
    t.throws(function () ***REMOVED*** impl.Buffer.from(10) ***REMOVED***)
    t.throws(function () ***REMOVED*** impl.Buffer.from(10, 'utf-8') ***REMOVED***)
    t.throws(function () ***REMOVED*** impl.Buffer.from('string', 'invalid encoding') ***REMOVED***)
    t.throws(function () ***REMOVED*** impl.Buffer.from(-10) ***REMOVED***)
    t.throws(function () ***REMOVED*** impl.Buffer.from(1e90) ***REMOVED***)
    t.throws(function () ***REMOVED*** impl.Buffer.from(Infinity) ***REMOVED***)
    t.throws(function () ***REMOVED*** impl.Buffer.from(-Infinity) ***REMOVED***)
    t.throws(function () ***REMOVED*** impl.Buffer.from(NaN) ***REMOVED***)
    t.throws(function () ***REMOVED*** impl.Buffer.from(null) ***REMOVED***)
    t.throws(function () ***REMOVED*** impl.Buffer.from(undefined) ***REMOVED***)
    t.throws(function () ***REMOVED*** impl.Buffer.from() ***REMOVED***)
    t.throws(function () ***REMOVED*** impl.Buffer.from(***REMOVED******REMOVED***) ***REMOVED***)
    t.throws(function () ***REMOVED*** impl.Buffer.alloc('') ***REMOVED***)
    t.throws(function () ***REMOVED*** impl.Buffer.alloc('string') ***REMOVED***)
    t.throws(function () ***REMOVED*** impl.Buffer.alloc('string', 'utf-8') ***REMOVED***)
    t.throws(function () ***REMOVED*** impl.Buffer.alloc('b25ldHdvdGhyZWU=', 'base64') ***REMOVED***)
    t.throws(function () ***REMOVED*** impl.Buffer.alloc(-10) ***REMOVED***)
    t.throws(function () ***REMOVED*** impl.Buffer.alloc(1e90) ***REMOVED***)
    t.throws(function () ***REMOVED*** impl.Buffer.alloc(2 * (1 << 30)) ***REMOVED***)
    t.throws(function () ***REMOVED*** impl.Buffer.alloc(Infinity) ***REMOVED***)
    t.throws(function () ***REMOVED*** impl.Buffer.alloc(-Infinity) ***REMOVED***)
    t.throws(function () ***REMOVED*** impl.Buffer.alloc(null) ***REMOVED***)
    t.throws(function () ***REMOVED*** impl.Buffer.alloc(undefined) ***REMOVED***)
    t.throws(function () ***REMOVED*** impl.Buffer.alloc() ***REMOVED***)
    t.throws(function () ***REMOVED*** impl.Buffer.alloc([]) ***REMOVED***)
    t.throws(function () ***REMOVED*** impl.Buffer.alloc([0, 42, 3]) ***REMOVED***)
    t.throws(function () ***REMOVED*** impl.Buffer.alloc(***REMOVED******REMOVED***) ***REMOVED***)
  ***REMOVED***);
  ['allocUnsafe', 'allocUnsafeSlow'].forEach(function (method) ***REMOVED***
    t.throws(function () ***REMOVED*** dangerous.Buffer[method]('') ***REMOVED***)
    t.throws(function () ***REMOVED*** dangerous.Buffer[method]('string') ***REMOVED***)
    t.throws(function () ***REMOVED*** dangerous.Buffer[method]('string', 'utf-8') ***REMOVED***)
    t.throws(function () ***REMOVED*** dangerous.Buffer[method](2 * (1 << 30)) ***REMOVED***)
    t.throws(function () ***REMOVED*** dangerous.Buffer[method](Infinity) ***REMOVED***)
    if (dangerous.Buffer[method] === buffer.Buffer.allocUnsafe) ***REMOVED***
      t.skip('Skipping, older impl of allocUnsafe coerced negative sizes to 0')
    ***REMOVED*** else ***REMOVED***
      t.throws(function () ***REMOVED*** dangerous.Buffer[method](-10) ***REMOVED***)
      t.throws(function () ***REMOVED*** dangerous.Buffer[method](-1e90) ***REMOVED***)
      t.throws(function () ***REMOVED*** dangerous.Buffer[method](-Infinity) ***REMOVED***)
    ***REMOVED***
    t.throws(function () ***REMOVED*** dangerous.Buffer[method](null) ***REMOVED***)
    t.throws(function () ***REMOVED*** dangerous.Buffer[method](undefined) ***REMOVED***)
    t.throws(function () ***REMOVED*** dangerous.Buffer[method]() ***REMOVED***)
    t.throws(function () ***REMOVED*** dangerous.Buffer[method]([]) ***REMOVED***)
    t.throws(function () ***REMOVED*** dangerous.Buffer[method]([0, 42, 3]) ***REMOVED***)
    t.throws(function () ***REMOVED*** dangerous.Buffer[method](***REMOVED******REMOVED***) ***REMOVED***)
  ***REMOVED***)
  t.end()
***REMOVED***)

test('Buffers have appropriate lengths', function (t) ***REMOVED***
  [index, safer, dangerous].forEach(function (impl) ***REMOVED***
    t.equal(impl.Buffer.alloc(0).length, 0)
    t.equal(impl.Buffer.alloc(10).length, 10)
    t.equal(impl.Buffer.from('').length, 0)
    t.equal(impl.Buffer.from('string').length, 6)
    t.equal(impl.Buffer.from('string', 'utf-8').length, 6)
    t.equal(impl.Buffer.from('b25ldHdvdGhyZWU=', 'base64').length, 11)
    t.equal(impl.Buffer.from([0, 42, 3]).length, 3)
    t.equal(impl.Buffer.from(new Uint8Array([0, 42, 3])).length, 3)
    t.equal(impl.Buffer.from([]).length, 0)
  ***REMOVED***);
  ['allocUnsafe', 'allocUnsafeSlow'].forEach(function (method) ***REMOVED***
    t.equal(dangerous.Buffer[method](0).length, 0)
    t.equal(dangerous.Buffer[method](10).length, 10)
  ***REMOVED***)
  t.end()
***REMOVED***)

test('Buffers have appropriate lengths (2)', function (t) ***REMOVED***
  t.equal(index.Buffer.alloc, safer.Buffer.alloc)
  t.equal(index.Buffer.alloc, dangerous.Buffer.alloc)
  var ok = true;
  [ safer.Buffer.alloc,
    dangerous.Buffer.allocUnsafe,
    dangerous.Buffer.allocUnsafeSlow
  ].forEach(function (method) ***REMOVED***
    for (var i = 0; i < 1e2; i++) ***REMOVED***
      var length = Math.round(Math.random() * 1e5)
      var buf = method(length)
      if (!buffer.Buffer.isBuffer(buf)) ok = false
      if (buf.length !== length) ok = false
    ***REMOVED***
  ***REMOVED***)
  t.ok(ok)
  t.end()
***REMOVED***)

test('.alloc(size) is zero-filled and has correct length', function (t) ***REMOVED***
  t.equal(index.Buffer.alloc, safer.Buffer.alloc)
  t.equal(index.Buffer.alloc, dangerous.Buffer.alloc)
  var ok = true
  for (var i = 0; i < 1e2; i++) ***REMOVED***
    var length = Math.round(Math.random() * 2e6)
    var buf = index.Buffer.alloc(length)
    if (!buffer.Buffer.isBuffer(buf)) ok = false
    if (buf.length !== length) ok = false
    var j
    for (j = 0; j < length; j++) ***REMOVED***
      if (buf[j] !== 0) ok = false
    ***REMOVED***
    buf.fill(1)
    for (j = 0; j < length; j++) ***REMOVED***
      if (buf[j] !== 1) ok = false
    ***REMOVED***
  ***REMOVED***
  t.ok(ok)
  t.end()
***REMOVED***)

test('.allocUnsafe / .allocUnsafeSlow are fillable and have correct lengths', function (t) ***REMOVED***
  ['allocUnsafe', 'allocUnsafeSlow'].forEach(function (method) ***REMOVED***
    var ok = true
    for (var i = 0; i < 1e2; i++) ***REMOVED***
      var length = Math.round(Math.random() * 2e6)
      var buf = dangerous.Buffer[method](length)
      if (!buffer.Buffer.isBuffer(buf)) ok = false
      if (buf.length !== length) ok = false
      buf.fill(0, 0, length)
      var j
      for (j = 0; j < length; j++) ***REMOVED***
        if (buf[j] !== 0) ok = false
      ***REMOVED***
      buf.fill(1, 0, length)
      for (j = 0; j < length; j++) ***REMOVED***
        if (buf[j] !== 1) ok = false
      ***REMOVED***
    ***REMOVED***
    t.ok(ok, method)
  ***REMOVED***)
  t.end()
***REMOVED***)

test('.alloc(size, fill) is `fill`-filled', function (t) ***REMOVED***
  t.equal(index.Buffer.alloc, safer.Buffer.alloc)
  t.equal(index.Buffer.alloc, dangerous.Buffer.alloc)
  var ok = true
  for (var i = 0; i < 1e2; i++) ***REMOVED***
    var length = Math.round(Math.random() * 2e6)
    var fill = Math.round(Math.random() * 255)
    var buf = index.Buffer.alloc(length, fill)
    if (!buffer.Buffer.isBuffer(buf)) ok = false
    if (buf.length !== length) ok = false
    for (var j = 0; j < length; j++) ***REMOVED***
      if (buf[j] !== fill) ok = false
    ***REMOVED***
  ***REMOVED***
  t.ok(ok)
  t.end()
***REMOVED***)

test('.alloc(size, fill) is `fill`-filled', function (t) ***REMOVED***
  t.equal(index.Buffer.alloc, safer.Buffer.alloc)
  t.equal(index.Buffer.alloc, dangerous.Buffer.alloc)
  var ok = true
  for (var i = 0; i < 1e2; i++) ***REMOVED***
    var length = Math.round(Math.random() * 2e6)
    var fill = Math.round(Math.random() * 255)
    var buf = index.Buffer.alloc(length, fill)
    if (!buffer.Buffer.isBuffer(buf)) ok = false
    if (buf.length !== length) ok = false
    for (var j = 0; j < length; j++) ***REMOVED***
      if (buf[j] !== fill) ok = false
    ***REMOVED***
  ***REMOVED***
  t.ok(ok)
  t.deepEqual(index.Buffer.alloc(9, 'a'), index.Buffer.alloc(9, 97))
  t.notDeepEqual(index.Buffer.alloc(9, 'a'), index.Buffer.alloc(9, 98))

  var tmp = new buffer.Buffer(2)
  tmp.fill('ok')
  if (tmp[1] === tmp[0]) ***REMOVED***
    // Outdated Node.js
    t.deepEqual(index.Buffer.alloc(5, 'ok'), index.Buffer.from('ooooo'))
  ***REMOVED*** else ***REMOVED***
    t.deepEqual(index.Buffer.alloc(5, 'ok'), index.Buffer.from('okoko'))
  ***REMOVED***
  t.notDeepEqual(index.Buffer.alloc(5, 'ok'), index.Buffer.from('kokok'))

  t.end()
***REMOVED***)

test('safer.Buffer.from returns results same as Buffer constructor', function (t) ***REMOVED***
  [index, safer, dangerous].forEach(function (impl) ***REMOVED***
    t.deepEqual(impl.Buffer.from(''), new buffer.Buffer(''))
    t.deepEqual(impl.Buffer.from('string'), new buffer.Buffer('string'))
    t.deepEqual(impl.Buffer.from('string', 'utf-8'), new buffer.Buffer('string', 'utf-8'))
    t.deepEqual(impl.Buffer.from('b25ldHdvdGhyZWU=', 'base64'), new buffer.Buffer('b25ldHdvdGhyZWU=', 'base64'))
    t.deepEqual(impl.Buffer.from([0, 42, 3]), new buffer.Buffer([0, 42, 3]))
    t.deepEqual(impl.Buffer.from(new Uint8Array([0, 42, 3])), new buffer.Buffer(new Uint8Array([0, 42, 3])))
    t.deepEqual(impl.Buffer.from([]), new buffer.Buffer([]))
  ***REMOVED***)
  t.end()
***REMOVED***)

test('safer.Buffer.from returns consistent results', function (t) ***REMOVED***
  [index, safer, dangerous].forEach(function (impl) ***REMOVED***
    t.deepEqual(impl.Buffer.from(''), impl.Buffer.alloc(0))
    t.deepEqual(impl.Buffer.from([]), impl.Buffer.alloc(0))
    t.deepEqual(impl.Buffer.from(new Uint8Array([])), impl.Buffer.alloc(0))
    t.deepEqual(impl.Buffer.from('string', 'utf-8'), impl.Buffer.from('string'))
    t.deepEqual(impl.Buffer.from('string'), impl.Buffer.from([115, 116, 114, 105, 110, 103]))
    t.deepEqual(impl.Buffer.from('string'), impl.Buffer.from(impl.Buffer.from('string')))
    t.deepEqual(impl.Buffer.from('b25ldHdvdGhyZWU=', 'base64'), impl.Buffer.from('onetwothree'))
    t.notDeepEqual(impl.Buffer.from('b25ldHdvdGhyZWU='), impl.Buffer.from('onetwothree'))
  ***REMOVED***)
  t.end()
***REMOVED***)
