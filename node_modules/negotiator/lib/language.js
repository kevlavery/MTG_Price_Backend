/**
 * negotiator
 * Copyright(c) 2012 Isaac Z. Schlueter
 * Copyright(c) 2014 Federico Romero
 * Copyright(c) 2014-2015 Douglas Christopher Wilson
 * MIT Licensed
 */

'use strict';

/**
 * Module exports.
 * @public
 */

module.exports = preferredLanguages;
module.exports.preferredLanguages = preferredLanguages;

/**
 * Module variables.
 * @private
 */

var simpleLanguageRegExp = /^\s*([^\s\-;]+)(?:-([^\s;]+))?\s*(?:;(.*))?$/;

/**
 * Parse the Accept-Language header.
 * @private
 */

function parseAcceptLanguage(accept) ***REMOVED***
  var accepts = accept.split(',');

  for (var i = 0, j = 0; i < accepts.length; i++) ***REMOVED***
    var langauge = parseLanguage(accepts[i].trim(), i);

    if (langauge) ***REMOVED***
      accepts[j++] = langauge;
    ***REMOVED***
  ***REMOVED***

  // trim accepts
  accepts.length = j;

  return accepts;
***REMOVED***

/**
 * Parse a language from the Accept-Language header.
 * @private
 */

function parseLanguage(str, i) ***REMOVED***
  var match = simpleLanguageRegExp.exec(str);
  if (!match) return null;

  var prefix = match[1],
      suffix = match[2],
      full = prefix;

  if (suffix) full += "-" + suffix;

  var q = 1;
  if (match[3]) ***REMOVED***
    var params = match[3].split(';')
    for (var i = 0; i < params.length; i ++) ***REMOVED***
      var p = params[i].split('=');
      if (p[0] === 'q') q = parseFloat(p[1]);
    ***REMOVED***
  ***REMOVED***

  return ***REMOVED***
    prefix: prefix,
    suffix: suffix,
    q: q,
    i: i,
    full: full
  ***REMOVED***;
***REMOVED***

/**
 * Get the priority of a language.
 * @private
 */

function getLanguagePriority(language, accepted, index) ***REMOVED***
  var priority = ***REMOVED***o: -1, q: 0, s: 0***REMOVED***;

  for (var i = 0; i < accepted.length; i++) ***REMOVED***
    var spec = specify(language, accepted[i], index);

    if (spec && (priority.s - spec.s || priority.q - spec.q || priority.o - spec.o) < 0) ***REMOVED***
      priority = spec;
    ***REMOVED***
  ***REMOVED***

  return priority;
***REMOVED***

/**
 * Get the specificity of the language.
 * @private
 */

function specify(language, spec, index) ***REMOVED***
  var p = parseLanguage(language)
  if (!p) return null;
  var s = 0;
  if(spec.full.toLowerCase() === p.full.toLowerCase())***REMOVED***
    s |= 4;
  ***REMOVED*** else if (spec.prefix.toLowerCase() === p.full.toLowerCase()) ***REMOVED***
    s |= 2;
  ***REMOVED*** else if (spec.full.toLowerCase() === p.prefix.toLowerCase()) ***REMOVED***
    s |= 1;
  ***REMOVED*** else if (spec.full !== '*' ) ***REMOVED***
    return null
  ***REMOVED***

  return ***REMOVED***
    i: index,
    o: spec.i,
    q: spec.q,
    s: s
  ***REMOVED***
***REMOVED***;

/**
 * Get the preferred languages from an Accept-Language header.
 * @public
 */

function preferredLanguages(accept, provided) ***REMOVED***
  // RFC 2616 sec 14.4: no header = *
  var accepts = parseAcceptLanguage(accept === undefined ? '*' : accept || '');

  if (!provided) ***REMOVED***
    // sorted list of all languages
    return accepts
      .filter(isQuality)
      .sort(compareSpecs)
      .map(getFullLanguage);
  ***REMOVED***

  var priorities = provided.map(function getPriority(type, index) ***REMOVED***
    return getLanguagePriority(type, accepts, index);
  ***REMOVED***);

  // sorted list of accepted languages
  return priorities.filter(isQuality).sort(compareSpecs).map(function getLanguage(priority) ***REMOVED***
    return provided[priorities.indexOf(priority)];
  ***REMOVED***);
***REMOVED***

/**
 * Compare two specs.
 * @private
 */

function compareSpecs(a, b) ***REMOVED***
  return (b.q - a.q) || (b.s - a.s) || (a.o - b.o) || (a.i - b.i) || 0;
***REMOVED***

/**
 * Get full language string.
 * @private
 */

function getFullLanguage(spec) ***REMOVED***
  return spec.full;
***REMOVED***

/**
 * Check if a spec has any quality.
 * @private
 */

function isQuality(spec) ***REMOVED***
  return spec.q > 0;
***REMOVED***
