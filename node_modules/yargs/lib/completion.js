var fs = require('fs'),
  path = require('path')

// add bash completions to your
//  yargs-powered applications.
module.exports = function (yargs, usage) ***REMOVED***
  var self = ***REMOVED***
    completionKey: 'get-yargs-completions'
  ***REMOVED***

  // get a list of completion commands.
  self.getCompletion = function (done) ***REMOVED***
    var completions = [],
    current = process.argv[process.argv.length - 1],
    previous = process.argv.slice(process.argv.indexOf('--' + self.completionKey) + 1),
    argv = yargs.parse(previous)

    // a custom completion function can be provided
    // to completion().
    if (completionFunction) ***REMOVED***
      if (completionFunction.length < 3) ***REMOVED***
        // synchronous completion function.
        return done(completionFunction(current, argv))
      ***REMOVED*** else ***REMOVED***
        // asynchronous completion function
        return completionFunction(current, argv, function (completions) ***REMOVED***
          done(completions)
        ***REMOVED***)
      ***REMOVED***
    ***REMOVED***

    if (!current.match(/^-/)) ***REMOVED***
      usage.getCommands().forEach(function (command) ***REMOVED***
        completions.push(command[0])
      ***REMOVED***)
    ***REMOVED***

    if (current.match(/^-/)) ***REMOVED***
      Object.keys(yargs.getOptions().key).forEach(function (key) ***REMOVED***
        completions.push('--' + key)
      ***REMOVED***)
    ***REMOVED***

    done(completions)
  ***REMOVED***

  // generate the completion script to add to your .bashrc.
  self.generateCompletionScript = function ($0) ***REMOVED***
    var script = fs.readFileSync(
      path.resolve(__dirname, '../completion.sh.hbs'),
      'utf-8'
    ),
    name = path.basename($0)

    // add ./to applications not yet installed as bin.
    if ($0.match(/\.js$/)) $0 = './' + $0

    script = script.replace(/***REMOVED******REMOVED***app_name***REMOVED******REMOVED***/g, name)
    return script.replace(/***REMOVED******REMOVED***app_path***REMOVED******REMOVED***/g, $0)
  ***REMOVED***

  // register a function to perform your own custom
  // completions., this function can be either
  // synchrnous or asynchronous.
  var completionFunction = null
  self.registerFunction = function (fn) ***REMOVED***
    completionFunction = fn
  ***REMOVED***

  return self
***REMOVED***
